<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Math Machine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS2DRenderer.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\$$', '\$$']],
                displayMath: [ ['$$', '$$'], ['\\[', '\\]'] ],
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif !important;
            font-weight: 400 !important;
            background-color: #ffffff;
        }
        .message-box {
            position: fixed; top: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444; color: white;
            padding: 1rem 1.5rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000; display: none;
            font-size: 1rem; font-weight: bold;
        }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input::placeholder, textarea::placeholder { font-weight: normal; color: #9ca3af; }
        .full-width-section { width: 100%; background-color: #f8fafc; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #shapeDisplayFullWidth, #shapeDisplay2D, #equationDisplayContainer, #graphingCanvasWrapper.graph-mode-layout { min-height: 250px; background-color: #dbeafe; border: 2px solid #e2e8f0; display: flex; justify-content: center; align-items: center; overflow: auto; position: relative; width: 100%; border-radius: 0.5rem; padding: 1rem; }
        #mathCanvas3D.three-d-canvas { position: absolute; top: 0; left: 0; z-index: 1; }
        #mathCanvas2D, #mathCanvas, #mathCanvas3D { background-color: transparent; display: block; width: 100%; height: 100%; }
        .hidden-mode, .hidden { display: none !important; }
        .toggle-btn { width: 3.5rem; height: 2rem; border-radius: 9999px; padding: 0.25rem; transition: background-color 0.2s ease-in-out; cursor: pointer; }
        .toggle-dot { width: 1.5rem; height: 1.5rem; background-color: white; border-radius: 9999px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); transition: transform 0.2s ease-in-out; }
        .toggle-on { background-image: linear-gradient(130deg, #2B6DFE, #00F2FF); }
        .toggle-off { background-color: #d1d5db; }
        .dot-on { transform: translateX(1.5rem); }
        .dimension-label { background-color: rgba(0, 0, 0, 0.6); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; white-space: nowrap; pointer-events: none; font-weight: bold; }
        .dimension-label-2d { position: absolute; background-color: rgba(0, 0, 0, 0.6); color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; transform: translate(-50%, -50%); pointer-events: none; display: none; }
        .css2d-container { position: absolute !important; top: 0px !important; left: 0px !important; pointer-events: none !important; overflow: hidden; z-index: 2; }
        #volumeSteps p, #stepsContentContainer p { font-family: serif !important; font-weight: normal !important; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; border: none; width: 32px; height: 32px; padding: 0; background: none; cursor: pointer; border-radius: 0.25rem; overflow: hidden; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid #e2e8f0; border-radius: 0.25rem; }
        .remove-line-button { background-color: transparent; color: #ef4444; border: none; padding: 0; font-size: 1.5rem; line-height: 1; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: color 0.2s ease-in-out; }
        .remove-line-button:hover { color: #dc2626; }
        #graphingContentWrapper.graph-mode-layout { display: flex; flex-direction: column; gap: 1rem; width: 100%; }
        #graphingInputsPanel.graph-mode-layout { position: relative; width: 100%; background-color: #f8fafc; padding: 1rem; border-radius: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #graphingCanvasWrapper.graph-mode-layout { width: 100%; height: auto; aspect-ratio: 16/10; background-color: white; border-radius: 0.5rem; overflow: hidden; border: 2px solid #e2e8f0; transition: width 0.3s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        @media (min-width: 768px) {
            #oldToolLayout.layout-side-by-side { flex-direction: row; }
            #oldToolLayout.layout-side-by-side #displayArea, #oldToolLayout.layout-side-by-side #calculationStepsColumn { height: auto; }
            #oldToolLayout.layout-side-by-side #shapeDisplayFullWidth, #oldToolLayout.layout-side-by-side #shapeDisplay2D { height: 100%; }
            #graphingContentWrapper.graph-mode-layout { flex-direction: row; }
            #graphingInputsPanel.graph-mode-layout { width: 33.333333%; }
            #graphingInputsPanel.graph-mode-layout.panel-hidden { width: 0; padding: 0; overflow: hidden; border: none; opacity: 0; }
            #graphingCanvasWrapper.graph-mode-layout { width: 66.666666%; height: 600px; }
            #graphingCanvasWrapper.graph-mode-layout.canvas-expanded { width: 100%; }
        }
        #manipulative_mainManipulativeDisplay { background-color: transparent; border: none; display: flex; justify-content: center; align-items: stretch; overflow: hidden; position: relative; width: 100%; flex-grow: 1; gap: 1rem; }
        .manipulative_canvas-container { background-color: #dbeafe; border: 2px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; display: flex; justify-content: center; align-items: flex-start; width: 100%; overflow: auto; }
        .manipulative_canvas-container.statement-mode-override { display: contents; }
        #manipulative_statementLiveText { flex: 1 1 0%; align-self: flex-start; width: 100%; word-break: break-word; line-height: 1.4; }
        #manipulative_focusStatementLiveText { width: 100%; word-break: break-word; line-height: 1.4; color: #1f2937; font-size: 2.25rem; margin: 0; }
        #manipulative_mathCanvas, #manipulative_leftMathCanvas, #manipulative_rightMathCanvas { display: block; background-color: transparent; }
        .fraction-input-row-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .fraction-input-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .remove-fraction-button { background-color: #ef4444; color: white; font-weight: bold; padding: 4px 8px; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s ease-in-out; margin-left: auto; }
        .remove-fraction-button:hover { background-color: #dc2626; }
        #manipulative_stepsContentContainer p { color: #22c55e; }
    </style>
</head>
<body class="bg-white flex items-center justify-center p-4">
    <div class="w-full mx-auto bg-white rounded-2xl p-6 flex flex-col gap-4 min-h-screen">
        <!-- Top controls row -->
        <div id="topControlsRow" class="flex flex-wrap items-center justify-between gap-4">
            <div id="menu-controls" class="flex flex-wrap items-center gap-4 justify-center md:justify-start">
                <select id="modeSelector" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 text-sm md:text-base rounded-lg transition border-2 border-transparent focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <!-- Options from Original Integrated Machine -->
                    <option value="simpleAngle">Simple Angle</option>
                    <option value="correspondingAngles">Corresponding Angles</option>
                    <option value="areaOfRectangle">Area of Rectangle</option>
                    <option value="perimeterOfRectangle">Perimeter of Rectangle</option>
                    <option value="areaOfTriangle">Area of Triangle</option>
                    <option value="perimeterOfTriangle">Perimeter of Triangle</option>
                    <option value="areaOfCircle">Area of Circle</option>
                    <option value="circumferenceOfCircle">Circumference of Circle</option>
                    <option value="volumeOfTriangularPrism">Volume of Triangular Prism</option>
                    <option value="surfaceAreaOfTriangularPrism">Surface Area of Triangular Prism</option>
                    <option value="netOfTriangularPrism">Net of Triangular Prism</option>
                    <option value="volumeOfRectangularPrism">Volume of Rectangular Prism</option>
                    <option value="surfaceAreaOfRectangularPrism">Surface Area of Rectangular Prism</option>
                    <option value="netOfRectangularPrism">Net of Rectangular Prism</option>
                    <option value="volumeOfCylinder">Volume of Cylinder</option>
                    <option value="surfaceAreaOfCylinder">Surface Area of Cylinder</option>
                    <option value="netOfCylinder">Net of Cylinder</option>
                    <option value="volumeOfCone">Volume of Cone</option>
                    <option value="surfaceAreaOfCone">Surface Area of Cone</option>
                    <option value="netOfCone">Net of Cone</option>
                    <option value="volumeOfSquarePyramid">Volume of Square Pyramid</option>
                    <option value="surfaceAreaOfSquarePyramid">Surface Area of Square Pyramid</option>
                    <option value="netOfSquarePyramid">Net of Square Pyramid</option>
                    <option value="linearEquationSolver">Solving for x (Linear Equation)</option>
                    <option value="additionAlgorithm">Addition Algorithm</option>
                    <option value="subtractionAlgorithm">Subtraction Algorithm</option>
                    <option value="multiplicationAlgorithm">Multiplication Algorithm</option>
                    <option value="longDivision">Long Division</option>
                    <option value="bedmasCalculator">BEDMAS Calculator</option>
                    <option value="tableEquation">Table Equation Finder</option>
                    <option value="fractionAddition">Fraction Addition</option>
                    <option value="fractionSubtraction">Fraction Subtraction</option>
                    <option value="fractionMultiplication">Fraction Multiplication</option>
                    <option value="fractionDivision">Fraction Division</option>
                    <option value="mixedAddition">Mixed Number Addition</option>
                    <option value="mixedSubtraction">Mixed Number Subtraction</option>
                    <option value="mixedMultiplication">Mixed Number Multiplication</option>
                    <option value="mixedDivision">Mixed Number Division</option>
                    <option value="numberline">Numberline</option>
                    <option value="lineGraph">Line Graph (Time Series)</option>
                    <option value="barGraph">Bar Graph</option>
                    <option value="pictograph">Pictograph</option>
                    <option value="stemAndLeafPlot">Stem and Leaf Plot</option>
                    <option value="currencyCalculator">US Currency Calculator</option>
                    <option value="canadianCurrencyCalculator">Canadian Currency Calculator</option>
                    <option value="graphingCalculator">Graphing Calculator</option>
                    <option value="shapeTransformationTool">Shape Transformation Tool</option>
                    <!-- Options from Manipulatives Machine -->
                    <option value="baseTenBlocks">Base Ten Blocks</option>
                    <option value="algebraTiles">Algebra Tiles</option>
                    <option value="analogClock">Analog Clock</option>
                    <option value="probabilitySpinner">Probability Spinner</option>
                    <option value="diceRoller">Dice Roller</option>
                    <option value="fractionStrips">Fraction Strips</option>
                    <option value="fractionCircles">Fraction Circles</option>
                    <option value="multiplicationArray">Multiplication Array</option>
                    <option value="tenFrame">Ten Frame</option>
                    <option value="hundredsChart">Hundreds Chart</option>
                    <option value="factorTree">Factor Tree</option>
                    <option value="multiplicationNumberBond">Multiplication Number Bond</option>
                    <option value="additionNumberBond">Addition Number Bond</option>
                    <option value="focusStatement">Focus Statement Mode</option> 
                    <option value="equationSolver">Equation Solver</option>
                    <option value="expressionSimplifier">Expression Simplifier</option>
                    <option value="scatterPlotBestFit">Scatter Plot & Line of Best Fit</option>
                    <option value="functionExplorer">Interactive Function Explorer</option>
                    <option value="scientificNotation">Scientific Notation Tool</option>
                    <option value="exponentRules">Exponent Rules Explorer</option>
                    <option value="irrationalExplorer">Irrational Number Explorer</option>
                    <option value="dataSetAnalyzer">Data Set Analyzer</option>
                    <option value="probabilitySimulator">Probability Simulator</option>
                    <option value="functionTransformation">Function Transformation Tool</option>
                    <option value="systemsOfEquations">Systems of Equations Solver</option>
                    <option value="linearEquationFromData">Linear Equation from Data</option>
                    <option value="congruenceSimilarity">Congruence/Similarity Explorer</option>
                    <option value="interactiveCoordinatePlane">Interactive Coordinate Plane</option>
                    <option value="geometricSeries">Geometric Series Visualizer</option> 
                    <option value="cardinality" selected>1. Cardinality Counter</option>
                    <option value="verticalComparison">1b. Vertical Object Counter</option>
                    <option value="numeralDisplay">2. Numeral Display</option>
                    <option value="wordProblemVisualizer">3. Word Problem Visualizer</option>
                    <option value="measurementComparator">4. Measurement Comparison</option>
                    <option value="shapeClassifier">5. 2D/3D Shape Classifier</option>
                    <option value="tallyChart">7. Tally Chart</option>
                    <option value="placeValue">8. Place Value Tool</option>
                    <option value="equivalencyTool">9. Fraction/Decimal/Percent Equivalence</option>
                    <option value="unitRateCalculator">11. Unit Rate Calculator</option>
                    <option value="integerOperations">12. Integer Operations Visualizer</option>
                    <option value="dataSetAnalyzer">14. Data Set Analyzer</option>
                    <option value="volumeOfSphere">16. Sphere Volume</option>
                    <option value="surfaceAreaOfSphere">16b. Sphere Surface Area</option>
                </select>
                <div id="dimensionInputsInline" class="flex flex-wrap justify-center lg:justify-start items-center gap-x-2 gap-y-4"></div>
            </div>
            <div class="flex items-center gap-6 ml-auto">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold">Menu</span>
                    <button id="menu-toggle-btn" class="toggle-btn toggle-on">
                        <div id="menu-toggle-dot" class="toggle-dot dot-on"></div>
                    </button>
                </div>
                <div id="answer-toggle-container" class="flex items-center gap-2">
                    <span class="text-sm font-semibold">Answer</span>
                    <button id="answer-toggle-btn" class="toggle-btn toggle-off">
                        <div id="answer-toggle-dot" class="toggle-dot"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Layout for "Old" Tools -->
        <div id="oldToolLayout" class="flex flex-1 flex-col gap-4">
            <div id="displayArea" class="flex-1">
                <div id="shapeDisplayFullWidth" class="hidden-mode h-full">
                    <canvas id="mathCanvas3D" class="w-full h-full three-d-canvas"></canvas>
                </div>
                <div id="shapeDisplay2D" class="hidden-mode h-full">
                    <canvas id="mathCanvas2D" class="w-full h-full"></canvas>
                </div>
                <div id="equationDisplayContainer" class="hidden-mode h-full">
                    <div id="equationDisplay" class="text-5xl font-bold p-4 w-full h-full flex items-center justify-center text-center"></div>
                </div>
            </div>
            <div id="calculationStepsColumn" class="flex-1 hidden-mode">
                <div id="volumeStepsBottom" class="full-width-section h-full flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Calculation Steps:</h3>
                    <div id="volumeSteps" class="bg-slate-50 p-4 rounded-lg border border-slate-200 flex-grow overflow-y-auto flex items-center justify-center">
                        <div id="stepsContentContainer" class="mx-auto w-full h-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layout for "New" Canvas Tools -->
        <div id="newToolLayout" class="hidden">
            <div id="graphingContentWrapper" class="graph-mode-layout">
                <div id="graphingInputsPanel" class="graph-mode-layout"></div>
                <div id="graphingCanvasWrapper" class="graph-mode-layout">
                    <canvas id="mathCanvas"></canvas>
                    <div id="zoomControls" class="absolute top-4 right-4 flex flex-col gap-2 z-10 hidden">
                        <button id="zoomInButton" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-md transition-transform transform hover:scale-105 active:scale-100 shadow-md text-xl leading-none h-8 w-8 flex items-center justify-center">+</button>
                        <button id="zoomOutButton" class="bg-blue-500 text-white font-semibold py-1 px-3 rounded-md transition-transform transform hover:scale-105 active:scale-100 shadow-md text-xl leading-none h-8 w-8 flex items-center justify-center">-</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Layout for Manipulative Tools -->
        <div id="manipulativeLayout" class="hidden w-full flex flex-col flex-grow gap-4">
            <div id="manipulative_singleModeControls" class="flex flex-wrap items-center gap-4 justify-center md:justify-start">
                 <div id="manipulative_dimensionInputsInline" class="flex flex-wrap justify-center lg:justify-start items-center gap-x-2 gap-y-4"></div>
            </div>
            <div id="manipulative_focusStatementModeControls" class="hidden w-full flex flex-col md:flex-row gap-6">
                <div class="flex-1 p-4 bg-slate-50 rounded-lg border flex flex-col">
                    <h3 class="font-bold text-lg mb-3 text-slate-800">Focus Statement</h3>
                    <textarea id="manipulative_focusStatementTextArea" class="w-full flex-grow p-2 border-2 border-slate-300 rounded-lg text-lg" placeholder="Enter text or MathJax... e.g., $$f(x) = \int_{-\infty}^\infty \hat{f}(\xi)\,e^{2 \pi i \xi x} \,d\xi$$"></textarea>
                </div>
            </div>
            <div id="manipulative_mainManipulativeDisplay" class="flex-grow">
                <div id="manipulative_singleCanvasContainer" class="manipulative_canvas-container w-full">
                    <canvas id="manipulative_mathCanvas"></canvas>
                </div>
                <div id="manipulative_focusStatementDisplayContainer" class="hidden manipulative_canvas-container w-full">
                    <p id="manipulative_focusStatementLiveText"></p>
                </div>
            </div>
            <div id="manipulative_totalValueSection" class="full-width-section flex-1">
                <h3 id="manipulative_totalValueTitle" class="text-lg font-bold text-slate-800 mb-2">Total Value:</h3>
                <div id="manipulative_totalValueContent" class="bg-slate-50 p-4 rounded-lg border border-slate-200 h-full overflow-x-auto flex flex-col justify-center">
                    <div id="manipulative_stepsContentContainer" class="mx-auto"></div>
                </div>
            </div>
        </div>

        <div id="messageBox" class="message-box"></div>
    </div>

    <script>
    // --- GLOBAL VARIABLES DECLARATION ---
    let modeSelector, messageBox, oldToolLayout, newToolLayout, displayArea, calculationStepsColumn;
    let shapeDisplayFullWidth, shapeDisplay2D, equationDisplayContainer, equationDisplay;
    let mathCanvas3D, mathCanvas2D, ctx2D, mathCanvas, ctx, dimensionInputsInline, stepsContentContainer;
    let menuToggleBtn, menuToggleDot, menuControls, answerToggleBtn, answerToggleDot, answerToggleContainer;
    let graphingInputsPanel, graphingCanvasWrapper, zoomControls, zoomInButton, zoomOutButton;
    let currentMode = 'simpleAngle';
    let scene, camera, renderer, prism, controls, labelRenderer, outline;
    let labels = [];
    let animationFrameId = null;
    let activeListeners = [];
    let pixelsPerUnit = 50;
    let nextLineColorIndex = 0;
    let currentShapeVertices = [];
    let originalShapeVertices = [];
    let shapeTransformations = { translateX: 0, translateY: 0, rotateAngle: 0, flipX: false, flipY: false, flipYEqualsX: false };

    // Constants
    const SHAPE_DISPLAY_SCALE = 2.0;
    const TARGET_VIEW_FILL_FACTOR = 0.7;
    const defaultLineColors = ['#0000FF', '#FF0000', '#008000', '#800080', '#FFA500', '#00CED1'];
    const quickShapeCoordinates = { square: "(1,1),(2,1),(2,2),(1,2)", triangle: "(1,1),(3,1),(2,3)", rectangle: "(1,1),(4,1),(4,2),(1,2)", rhombus: "(1,2),(3,1),(5,2),(3,3)" };
    const colors = { main: '#000000', answer: '#059669', point: '#FF0000', grid: '#e2e8f0', axis: '#64748b', primaryBlue: '#007bff', carry: '#ef4444', label: '#94a3b8' };
    const newCanvasModes = ['graphingCalculator', 'shapeTransformationTool'];
    const visualDisplayOnlyModes = ['numberline', 'lineGraph', 'barGraph', 'pictograph', 'stemAndLeafPlot', 'currencyCalculator', 'canadianCurrencyCalculator'];
    const sideBySideModes = [ 'simpleAngle', 'correspondingAngles', 'areaOfRectangle', 'perimeterOfRectangle', 'areaOfTriangle', 'perimeterOfTriangle', 'areaOfCircle', 'circumferenceOfCircle', 'volumeOfTriangularPrism', 'surfaceAreaOfTriangularPrism', 'netOfTriangularPrism', 'volumeOfRectangularPrism', 'surfaceAreaOfRectangularPrism', 'netOfRectangularPrism', 'volumeOfCylinder', 'surfaceAreaOfCylinder', 'netOfCylinder', 'volumeOfCone', 'surfaceAreaOfCone', 'netOfCone', 'volumeOfSquarePyramid', 'surfaceAreaOfSquarePyramid', 'netOfSquarePyramid' ];

    // Manipulative variables
    const manipulativeLayout = document.getElementById('manipulativeLayout');
    let manipulative_currentMasterMode = 'baseTenBlocks';
    let manipulative_isAnimating = { left: false, right: false, single: false };
    let manipulative_lastSpinnerRotation = { left: 0, right: 0, single: 0 };
    let manipulative_lastSpinnerResult = { left: null, right: null, single: null };
    let manipulative_lastDiceResult = { left: null, right: null, single: null };
    let manipulative_singleModeControls, manipulative_focusStatementModeControls, manipulative_dimensionInputsInline;
    let manipulative_mainManipulativeDisplay, manipulative_totalValueSection, manipulative_stepsContentContainer;
    let manipulative_totalValueTitle, manipulative_singleCanvasContainer, manipulative_focusStatementDisplayContainer;
    let manipulative_mathCanvas, manipulative_ctx, manipulative_focusStatementLiveText, manipulative_focusStatementTextArea;
    let manipulative_baseSize = 9;

    // Manipulative constants
    const manipulative_DEPTH_PERSPECTIVE_RATIO = 0.5;
    const manipulative_baseTenTransparency = 0.85;
    const manipulative_geometricShapeTransparency = 0.75;
    const manipulative_unitCubeColor = '#FFEB3B', manipulative_rodColor = '#4CAF50', manipulative_flatColor = '#2196F3', manipulative_block1000Color = '#F44336';
    const manipulative_fractionStripColor = '#4DB6AC', manipulative_fractionCircleColor = '#F06292', manipulative_fractionUnfilledColor = '#E0E0E0';
    const manipulative_factorTreeNodeColor = '#FFC107', manipulative_multiplicationBondColor = '#8BC34A', manipulative_additionBondColor = '#FF9800', manipulative_numberBondLineColor = '#757575';
    const manipulative_NUMBER_BOND_NODE_RADIUS = 30 * 1.25, manipulative_NUMBER_BOND_HORIZONTAL_SPACING = manipulative_NUMBER_BOND_NODE_RADIUS * 3, manipulative_NUMBER_BOND_VERTICAL_SPACING = manipulative_NUMBER_BOND_NODE_RADIUS * 2;
    const manipulative_chartCellColor = '#e0e0e0', manipulative_chartBorderColor = '#bbb', manipulative_tenFrameDotColor = '#FF5722';
    const manipulative_highlightPrimeColor = '#ffeb3b', manipulative_highlightEvenColor = '#4CAF50', manipulative_highlightOddColor = '#9C27B0', manipulative_highlightMultipleColor = '#2196F3', manipulative_highlightFactorColor = '#F44336';
    const manipulative_algebraTilePositiveX2Color = '#2196F3', manipulative_algebraTilePositiveXColor = '#4CAF50', manipulative_algebraTilePositiveOneColor = '#FFEB3B';
    const manipulative_algebraTileNegativeColor = '#F44336';
    const manipulative_mainOutlineColor = '#000000', manipulative_mainOutlineWidth = 1.5, manipulative_internalLineColor = '#000000', manipulative_internalLineWidth = 1;
    const manipulative_padding = 20, manipulative_minEffectiveBlockUnit = 8, manipulative_maxEffectiveBlockUnit = 30;
    const manipulative_spinnerColors = ["#ef4444", "#22c55e", "#3b82f6", "#f97316", "#f59e0b", "#8b5cf6", "#ffffff", "#0f172a", "#14b8a6", "#ec4899", "#6366f1", "#84cc16", "#f43f5e", "#0ea5e9", "#a855f7", "#eab308"];
    const manipulativeModes = ['baseTenBlocks', 'algebraTiles', 'analogClock', 'probabilitySpinner', 'diceRoller', 'fractionStrips', 'fractionCircles', 'multiplicationArray', 'tenFrame', 'hundredsChart', 'factorTree', 'multiplicationNumberBond', 'additionNumberBond', 'focusStatement'];

    // --- DOM INITIALIZATION ---
    function initializeDOM() {
        modeSelector = document.getElementById('modeSelector');
        messageBox = document.getElementById('messageBox');
        oldToolLayout = document.getElementById('oldToolLayout');
        newToolLayout = document.getElementById('newToolLayout');
        displayArea = document.getElementById('displayArea');
        calculationStepsColumn = document.getElementById('calculationStepsColumn');
        shapeDisplayFullWidth = document.getElementById('shapeDisplayFullWidth');
        shapeDisplay2D = document.getElementById('shapeDisplay2D');
        equationDisplayContainer = document.getElementById('equationDisplayContainer');
        equationDisplay = document.getElementById('equationDisplay');
        mathCanvas3D = document.getElementById('mathCanvas3D');
        mathCanvas2D = document.getElementById('mathCanvas2D');
        if (mathCanvas2D) ctx2D = mathCanvas2D.getContext('2d');
        mathCanvas = document.getElementById('mathCanvas');
        if (mathCanvas) ctx = mathCanvas.getContext('2d');
        dimensionInputsInline = document.getElementById('dimensionInputsInline');
        stepsContentContainer = document.getElementById('stepsContentContainer');
        menuToggleBtn = document.getElementById('menu-toggle-btn');
        menuToggleDot = document.getElementById('menu-toggle-dot');
        menuControls = document.getElementById('menu-controls');
        answerToggleBtn = document.getElementById('answer-toggle-btn');
        answerToggleDot = document.getElementById('answer-toggle-dot');
        answerToggleContainer = document.getElementById('answer-toggle-container');
        graphingInputsPanel = document.getElementById('graphingInputsPanel');
        graphingCanvasWrapper = document.getElementById('graphingCanvasWrapper');
        zoomControls = document.getElementById('zoomControls');

        // Manipulative elements
        manipulative_singleModeControls = document.getElementById('manipulative_singleModeControls');
        manipulative_focusStatementModeControls = document.getElementById('manipulative_focusStatementModeControls');
        manipulative_dimensionInputsInline = document.getElementById('manipulative_dimensionInputsInline');
        manipulative_mainManipulativeDisplay = document.getElementById('manipulative_mainManipulativeDisplay');
        manipulative_totalValueSection = document.getElementById('manipulative_totalValueSection');
        manipulative_stepsContentContainer = document.getElementById('manipulative_stepsContentContainer');
        manipulative_totalValueTitle = document.getElementById('manipulative_totalValueTitle');
        manipulative_singleCanvasContainer = document.getElementById('manipulative_singleCanvasContainer');
        manipulative_focusStatementDisplayContainer = document.getElementById('manipulative_focusStatementDisplayContainer');
        manipulative_mathCanvas = document.getElementById('manipulative_mathCanvas');
        if (manipulative_mathCanvas) manipulative_ctx = manipulative_mathCanvas.getContext('2d');
        manipulative_focusStatementLiveText = document.getElementById('manipulative_focusStatementLiveText');
        manipulative_focusStatementTextArea = document.getElementById('manipulative_focusStatementTextArea');
    }

    // --- INPUT TEMPLATES ---
    const inputTemplates = {
        simpleAngle:`<div class="flex items-center gap-2"><label for="angleValue" class="text-sm font-semibold text-slate-700">Angle (°):</label><input type="number" id="angleValue" value="45" min="0" max="360" class="w-20 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        correspondingAngles:`<div class="flex items-center gap-2"><label for="corrAngleValue" class="text-sm font-semibold text-slate-700">Angle 1 (°):</label><input type="number" id="corrAngleValue" value="60" min="1" max="179" class="w-20 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><input type="checkbox" id="mysteryAngleToggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="mysteryAngleToggle" class="text-sm font-semibold text-slate-700">Mystery Mode</label></div>`,
        volumeOfTriangularPrism:`<div class="flex items-center gap-2"><label for="triangleBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="triangleBase" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="triangleHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="triangleHeight" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="prismLength" class="text-sm font-semibold text-slate-700">Length (L):</label><input type="number" id="prismLength" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        surfaceAreaOfTriangularPrism:`<div class="flex items-center gap-2"><label for="saTriBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="saTriBase" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saTriHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="saTriHeight" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saTriSide1" class="text-sm font-semibold text-slate-700">Side 1 (s1):</label><input type="number" id="saTriSide1" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saTriSide2" class="text-sm font-semibold text-slate-700">Side 2 (s2):</label><input type="number" id="saTriSide2" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saTriSide3" class="text-sm font-semibold text-slate-700">Side 3 (s3):</label><input type="number" id="saTriSide3" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saPrismHeight" class="text-sm font-semibold text-slate-700">Prism Height (H):</label><input type="number" id="saPrismHeight" value="8" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        netOfTriangularPrism:`<div class="flex items-center gap-2"><label for="netTriBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="netTriBase" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netTriHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="netTriHeight" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netPrismLength" class="text-sm font-semibold text-slate-700">Length (L):</label><input type="number" id="netPrismLength" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        volumeOfRectangularPrism:`<div class="flex items-center gap-2"><label for="rectBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="rectBase" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="rectHeightBase" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="rectHeightBase" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="rectDepthPrism" class="text-sm font-semibold text-slate-700">Depth (d):</label><input type="number" id="rectDepthPrism" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        surfaceAreaOfRectangularPrism:`<div class="flex items-center gap-2"><label for="saRectWidth" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="saRectWidth" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saRectDepth" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="saRectDepth" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saRectHeight" class="text-sm font-semibold text-slate-700">Depth (d):</label><input type="number" id="saRectHeight" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        netOfRectangularPrism:`<div class="flex items-center gap-2"><label for="netRectBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="netRectBase" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netRectHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="netRectHeight" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netRectDepth" class="text-sm font-semibold text-slate-700">Depth (d):</label><input type="number" id="netRectDepth" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        volumeOfCylinder:`<div class="flex items-center gap-2"><label for="cylinderRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="cylinderRadius" value="2" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="cylinderHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="cylinderHeight" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        surfaceAreaOfCylinder:`<div class="flex items-center gap-2"><label for="saCylinderRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="saCylinderRadius" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="saCylinderHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="saCylinderHeight" value="7" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        netOfCylinder:`<div class="flex items-center gap-2"><label for="netCylinderRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="netCylinderRadius" value="2" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netCylinderHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="netCylinderHeight" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        volumeOfCone:`<div class="flex items-center gap-2"><label for="coneRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="coneRadius" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="coneHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="coneHeight" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        surfaceAreaOfCone:`<div class="flex items-center gap-2"><label for="coneSARadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="coneSARadius" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="coneSAHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="coneSAHeight" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="coneSASlantHeight" class="text-sm font-semibold text-slate-700">Slant (l):</label><input type="number" id="coneSASlantHeight" placeholder="auto" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center" disabled></div>`,
        netOfCone:`<div class="flex items-center gap-2"><label for="netConeRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="netConeRadius" value="3" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netConeHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="netConeHeight" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        volumeOfSquarePyramid:`<div class="flex items-center gap-2"><label for="pyramidBaseSide" class="text-sm font-semibold text-slate-700">Base Side (b):</label><input type="number" id="pyramidBaseSide" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="pyramidHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="pyramidHeight" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        surfaceAreaOfSquarePyramid:`<div class="flex items-center gap-2"><label for="pyramidSABaseSide" class="text-sm font-semibold text-slate-700">Base Side (b):</label><input type="number" id="pyramidSABaseSide" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="pyramidSAHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="pyramidSAHeight" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="pyramidSASlantHeight" class="text-sm font-semibold text-slate-700">Slant (l):</label><input type="number" id="pyramidSASlantHeight" placeholder="auto" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center" disabled></div>`,
        netOfSquarePyramid:`<div class="flex items-center gap-2"><label for="netPyramidBaseSide" class="text-sm font-semibold text-slate-700">Base Side (b):</label><input type="number" id="netPyramidBaseSide" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="netPyramidHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="netPyramidHeight" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        areaOfRectangle:`<div class="flex items-center gap-2"><label for="rectAreaLength" class="text-sm font-semibold text-slate-700">Length (l):</label><input type="number" id="rectAreaLength" value="10" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="rectAreaWidth" class="text-sm font-semibold text-slate-700">Width (w):</label><input type="number" id="rectAreaWidth" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        perimeterOfRectangle:`<div class="flex items-center gap-2"><label for="rectPerimeterLength" class="text-sm font-semibold text-slate-700">Length (l):</label><input type="number" id="rectPerimeterLength" value="10" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="rectPerimeterWidth" class="text-sm font-semibold text-slate-700">Width (w):</label><input type="number" id="rectPerimeterWidth" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        areaOfTriangle:`<div class="flex items-center gap-2"><label for="triAreaBase" class="text-sm font-semibold text-slate-700">Base (b):</label><input type="number" id="triAreaBase" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="triAreaHeight" class="text-sm font-semibold text-slate-700">Height (h):</label><input type="number" id="triAreaHeight" value="4" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        perimeterOfTriangle:`<div class="flex items-center gap-2"><label for="triPerimeterSideA" class="text-sm font-semibold text-slate-700">Side A (a):</label><input type="number" id="triPerimeterSideA" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="triPerimeterSideB" class="text-sm font-semibold text-slate-700">Side B (b):</label><input type="number" id="triPerimeterSideB" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="triPerimeterSideC" class="text-sm font-semibold text-slate-700">Side C (c):</label><input type="number" id="triPerimeterSideC" value="6" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        areaOfCircle:`<div class="flex items-center gap-2"><label for="circleAreaRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="circleAreaRadius" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        circumferenceOfCircle:`<div class="flex items-center gap-2"><label for="circleCircumferenceRadius" class="text-sm font-semibold text-slate-700">Radius (r):</label><input type="number" id="circleCircumferenceRadius" value="5" class="w-12 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        linearEquationSolver: `<div class="flex items-center gap-2"><label for="coeffA" class="text-sm font-semibold text-slate-700">a:</label><input type="number" id="coeffA" value="2" class="w-16 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="coeffB" class="text-sm font-semibold text-slate-700">b:</label><input type="number" id="coeffB" value="5" class="w-16 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="coeffC" class="text-sm font-semibold text-slate-700">c:</label><input type="number" id="coeffC" value="15" class="w-16 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        additionAlgorithm: `<div class="flex items-center gap-2"><label for="num1" class="text-sm font-semibold text-slate-700">Num 1:</label><input type="number" id="num1" value="123" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="num2" class="text-sm font-semibold text-slate-700">Num 2:</label><input type="number" id="num2" value="45" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        subtractionAlgorithm: `<div class="flex items-center gap-2"><label for="num1" class="text-sm font-semibold text-slate-700">Num 1:</label><input type="number" id="num1" value="100" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="num2" class="text-sm font-semibold text-slate-700">Num 2:</label><input type="number" id="num2" value="1" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        multiplicationAlgorithm: `<div class="flex items-center gap-2"><label for="num1" class="text-sm font-semibold text-slate-700">Num 1:</label><input type="number" id="num1" value="123" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="num2" class="text-sm font-semibold text-slate-700">Num 2:</label><input type="number" id="num2" value="45" class="w-24 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        longDivision: `<div class="flex items-center gap-2"><input type="number" id="dividend" value="3461" min="0" placeholder="Dividend" class="w-24 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"><span class="text-2xl font-bold text-slate-400">÷</span><input type="number" id="divisor" value="35" min="1" placeholder="Divisor" class="w-24 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"></div>`,
        bedmasCalculator: `<div class="flex items-center gap-2"><label for="expression" class="text-sm font-semibold text-slate-700">Expression:</label><input type="text" id="expression" value="3 + 4 * 2 / (1 - 5)^2" class="w-64 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"></div>`,
        tableEquation: `<div class="flex items-center justify-center gap-2"><label for="xVal1" class="text-sm font-semibold text-slate-700">x:</label><input type="number" id="xVal1" value="2" class="table-x w-16 p-1 border-2 border-slate-300 rounded-lg text-center"><label for="yVal1" class="text-sm font-semibold text-slate-700">y:</label><input type="number" id="yVal1" value="6" class="table-y w-16 p-1 border-2 border-slate-300 rounded-lg text-center"></div><div id="table-container" class="flex flex-col gap-2"></div><button id="add-table-row" class="mt-2 bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm">+</button>`,
        fractionAddition: `<div class="flex items-center justify-center gap-4"><div class="flex flex-col items-center"><input type="number" id="num1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div><span class="text-4xl font-light">+</span><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="3" class="w-16 p-1 text-center border-2 rounded-lg"></div></div>`,
        fractionSubtraction: `<div class="flex items-center justify-center gap-4"><div class="flex flex-col items-center"><input type="number" id="num1" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="4" class="w-16 p-1 text-center border-2 rounded-lg"></div><span class="text-4xl font-light">-</span><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div>`,
        fractionMultiplication: `<div class="flex items-center justify-center gap-4"><div class="flex flex-col items-center"><input type="number" id="num1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="3" class="w-16 p-1 text-center border-2 rounded-lg"></div><span class="text-4xl font-light">$\\times$</span><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div>`,
        fractionDivision: `<div class="flex items-center justify-center gap-4"><div class="flex flex-col items-center"><input type="number" id="num1" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="4" class="w-16 p-1 text-center border-2 rounded-lg"></div><span class="text-4xl font-light">$\\div$</span><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div>`,
        mixedAddition: `<div class="flex items-center justify-center gap-4"><div class="flex items-center gap-2"><input type="number" id="whole1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div><span class="text-4xl font-light">+</span><div class="flex items-center gap-2"><input type="number" id="whole2" value="2" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="3" class="w-16 p-1 text-center border-2 rounded-lg"></div></div></div>`,
        mixedSubtraction: `<div class="flex items-center justify-center gap-4"><div class="flex items-center gap-2"><input type="number" id="whole1" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div><span class="text-4xl font-light">-</span><div class="flex items-center gap-2"><input type="number" id="whole2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num2" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="4" class="w-16 p-1 text-center border-2 rounded-lg"></div></div></div>`,
        mixedMultiplication: `<div class="flex items-center justify-center gap-4"><div class="flex items-center gap-2"><input type="number" id="whole1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div><span class="text-4xl font-light">$\\times$</span><div class="flex items-center gap-2"><input type="number" id="whole2" value="2" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="3" class="w-16 p-1 text-center border-2 rounded-lg"></div></div></div>`,
        mixedDivision: `<div class="flex items-center justify-center gap-4"><div class="flex items-center gap-2"><input type="number" id="whole1" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num1" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den1" value="2" class="w-16 p-1 text-center border-2 rounded-lg"></div></div><span class="text-4xl font-light">$\\div$</span><div class="flex items-center gap-2"><input type="number" id="whole2" value="1" class="w-16 p-1 text-center border-2 rounded-lg"><div class="flex flex-col items-center"><input type="number" id="num2" value="3" class="w-16 p-1 text-center border-2 rounded-lg"><div class="h-px w-16 bg-slate-800 my-1"></div><input type="number" id="den2" value="4" class="w-16 p-1 text-center border-2 rounded-lg"></div></div></div>`,
        numberline: `<div class="flex items-center gap-2"><label for="numStart" class="text-sm font-semibold text-slate-700">Start:</label><input type="number" id="numStart" value="-10" class="w-20 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="numEnd" class="text-sm font-semibold text-slate-700">End:</label><input type="number" id="numEnd" value="10" class="w-20 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div><div class="flex items-center gap-2"><label for="numStep" class="text-sm font-semibold text-slate-700">Step:</label><input type="number" id="numStep" value="1" class="w-20 p-1 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition text-center"></div>`,
        lineGraph: `<div id="graph-data-container" class="flex flex-col gap-2"></div><button id="add-graph-row" class="mt-2 bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm">+</button>`,
        barGraph: `<div id="graph-data-container" class="flex flex-col gap-2"></div><button id="add-graph-row" class="mt-2 bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm">+</button>`,
        pictograph: `<div class="flex items-center gap-4"><select id="pico-emoji" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg"><option>⭐</option><option>❤️</option><option>👍</option><option>🍎</option><option>🚗</option><option>⚽️</option><option>😃</option></select><div id="graph-data-container" class="flex flex-col gap-2"></div><button id="add-graph-row" class="mt-2 bg-indigo-500 text-white font-bold py-1 px-3 rounded-lg text-sm">+</button></div>`,
        stemAndLeafPlot: `<div><textarea id="stem-leaf-data" class="w-full p-2 border-2 border-slate-300 rounded-lg" rows="4" placeholder="Enter numbers separated by commas, e.g., 10, 22, 11, 35, 23, 4, 35"></textarea></div>`,
        currencyCalculator: `<div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="flex items-center gap-2"><label class="w-16">$100:</label><input type="number" id="curr-100" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$50:</label><input type="number" id="curr-50" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$20:</label><input type="number" id="curr-20" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$10:</label><input type="number" id="curr-10" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$5:</label><input type="number" id="curr-5" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$1:</label><input type="number" id="curr-1" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">25¢:</label><input type="number" id="curr-0.25" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">10¢:</label><input type="number" id="curr-0.10" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">5¢:</label><input type="number" id="curr-0.05" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">1¢:</label><input type="number" id="curr-0.01" class="currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div></div>`,
        canadianCurrencyCalculator: `<div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="flex items-center gap-2"><label class="w-16">$100:</label><input type="number" id="can-curr-100" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$50:</label><input type="number" id="can-curr-50" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$20:</label><input type="number" id="can-curr-20" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$10:</label><input type="number" id="can-curr-10" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$5:</label><input type="number" id="can-curr-5" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$2:</label><input type="number" id="can-curr-2" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">$1:</label><input type="number" id="can-curr-1" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">25¢:</label><input type="number" id="can-curr-0.25" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">10¢:</label><input type="number" id="can-curr-0.10" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">5¢:</label><input type="number" id="can-curr-0.05" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div><div class="flex items-center gap-2"><label class="w-16">1¢:</label><input type="number" id="can-curr-0.01" class="canadian-currency-input w-20 p-1 border-2 rounded-lg text-center" value="0" min="0"></div></div>`,
        graphingCalculatorInputs: `<div id="equationLinesContainer" class="flex flex-col gap-2 w-full"></div>`,
        shapeTransformationToolInputs: `<div class="flex flex-col gap-3 w-full"><label for="polygonInput" class="text-sm font-normal text-slate-700">Polygon Co-ordinates:</label><input type="text" id="polygonInput" value="(1,1),(2,1),(2,2),(1,2)" placeholder="(x1,y1),(x2,y2),..." class="w-full p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-sm font-normal"><div class="grid grid-cols-2 gap-2 mt-4"><button type="button" id="squareQuickShape" class="bg-gray-200 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-300 transition text-xs">Square</button><button type="button" id="triangleQuickShape" class="bg-gray-200 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-300 transition text-xs">Triangle</button><button type="button" id="rectangleQuickShape" class="bg-gray-200 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-300 transition text-xs">Rectangle</button><button type="button" id="rhombusQuickShape" class="bg-gray-200 text-gray-800 font-semibold py-1 px-2 rounded-lg hover:bg-gray-300 transition text-xs">Rhombus</button></div><div class="grid grid-cols-2 gap-2 mt-4"><label for="translateX" class="col-span-1 text-sm font-normal text-slate-700">Translate X:</label><input type="number" id="translateX" value="0" class="col-span-1 w-16 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition font-normal"><label for="translateY" class="col-span-1 text-sm font-normal text-slate-700">Translate Y:</label><input type="number" id="translateY" value="0" class="col-span-1 w-16 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition font-normal"><label for="rotateAngle" class="col-span-1 text-sm font-normal text-slate-700">Rotate (degrees):</label><input type="number" id="rotateAngle" value="0" class="col-span-1 w-16 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition font-normal"><label class="col-span-2 text-sm font-normal text-slate-700">Rotate About (x,y):</label><input type="number" id="rotateOriginX" value="" placeholder="X" class="col-span-1 w-16 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition font-normal"><input type="number" id="rotateOriginY" value="" placeholder="Y" class="col-span-1 w-16 p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition font-normal"></div><div class="grid grid-cols-2 gap-2 mt-2"><span class="col-span-2 text-sm font-normal text-slate-700">Flip:</span><div class="flex items-center"><input type="radio" id="flipNone" name="flipAxis" value="none" checked><label for="flipNone" class="ml-1 text-sm font-normal text-slate-600">None</label></div><div class="flex items-center"><input type="radio" id="flipX" name="flipAxis" value="x"><label for="flipX" class="ml-1 text-sm font-normal text-slate-600">X-axis</label></div><div class="flex items-center"><input type="radio" id="flipY" name="flipAxis" value="y"><label for="flipY" class="ml-1 text-sm font-normal text-slate-600">Y-axis</label></div><div class="flex items-center"><input type="radio" id="flipYEqualsX" name="flipAxis" value="y=x"><label for="flipYEqualsX" class="ml-1 text-sm font-normal text-slate-600">Y=X</label></div></div><div class="flex justify-start gap-2 mt-4"><button type="button" id="applyShapeTransform" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 active:scale-100 shadow-md">Apply Transformation</button><button type="button" id="resetShapeTransform" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-transform transform hover:scale-105 active:scale-100 shadow-md">Reset Shape</button></div></div>`,
        baseTenBlocks: `<div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="flex flex-col items-center"><label class="text-sm font-semibold text-slate-700">Thousands:</label><input type="number" id="manipulative_block-1000_{SIDE}" class="block-input w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="0" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-slate-700">Hundreds:</label><input type="number" id="manipulative_block-100_{SIDE}" class="block-input w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="0" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-slate-700">Tens:</label><input type="number" id="manipulative_block-10_{SIDE}" class="block-input w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="0" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-slate-700">Ones:</label><input type="number" id="manipulative_block-1_{SIDE}" class="block-input w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="0" min="0"></div></div>`,
        algebraTiles: `<div class="grid grid-cols-3 md:grid-cols-6 gap-x-4 gap-y-2"><div class="flex flex-col items-center"><label class="text-sm font-semibold text-blue-600">$x^2$</label><input type="number" id="manipulative_tile-x2_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="1" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-green-600">$x$</label><input type="number" id="manipulative_tile-x_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="2" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-yellow-500">$1$</label><input type="number" id="manipulative_tile-1_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="3" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-red-600">$-x^2$</label><input type="number" id="manipulative_tile-neg-x2_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="0" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-red-600">$-x$</label><input type="number" id="manipulative_tile-neg-x_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="1" min="0"></div><div class="flex flex-col items-center"><label class="text-sm font-semibold text-red-600">$-1$</label><input type="number" id="manipulative_tile-neg-1_{SIDE}" class="w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="2" min="0"></div></div>`,
        analogClock: `<div class="flex items-center gap-4"><label class="text-sm font-semibold text-slate-700">Hour:</label><input type="number" id="manipulative_clockHour_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="3" min="1" max="12"><label class="text-sm font-semibold text-slate-700">Minute:</label><input type="number" id="manipulative_clockMinute_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="15" min="0" max="59"></div>`,
        probabilitySpinner: `<div class="flex items-center gap-4"><label class="text-sm font-semibold text-slate-700">Sections:</label><input type="number" id="manipulative_spinnerSections_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="6" min="2" max="20"><button type="button" id="manipulative_spinButton_{SIDE}" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Spin</button></div>`,
        diceRoller: `<div class="flex items-center gap-4"><label class="text-sm font-semibold text-slate-700">Sides:</label><input type="number" id="manipulative_diceSides_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="6" min="1"><button type="button" id="manipulative_rollButton_{SIDE}" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Roll</button></div>`,
        fractionStrips: `<div id="manipulative_fractionStripInputsContainer_{SIDE}" class="flex flex-col gap-2 w-full"></div><button type="button" id="manipulative_addFractionStrip_{SIDE}" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Add Strip</button>`,
        fractionCircles: `<div id="manipulative_fractionCircleInputsContainer_{SIDE}" class="flex flex-col gap-2 w-full"></div><button type="button" id="manipulative_addFractionCircle_{SIDE}" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Add Circle</button>`,
        multiplicationArray: `<div class="flex items-center gap-2"><label class="text-sm font-semibold text-slate-700">Rows:</label><input type="number" id="manipulative_arrayRows_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="3" min="1" max="20"><span class="text-xl font-bold text-slate-700 mx-2">x</span><label class="text-sm font-semibold text-slate-700">Cols:</label><input type="number" id="manipulative_arrayCols_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="4" min="1" max="20"></div>`,
        tenFrame: `<div class="flex items-center gap-4"><label class="text-sm font-semibold text-slate-700">Frame Size:</label><select id="manipulative_tenFrameSize_{SIDE}" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 text-sm rounded-lg"><option value="10">10-Frame</option><option value="20">20-Frame</option><option value="30">30-Frame</option><option value="40">40-Frame</option><option value="50">50-Frame</option><option value="60">60-Frame</option><option value="70">70-Frame</option><option value="80">80-Frame</option><option value="90">90-Frame</option><option value="100">100-Frame</option></select><label class="text-sm font-semibold text-slate-700">Number of Dots:</label><input type="number" id="manipulative_tenFrameDots_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center" value="7" min="0"></div>`,
        hundredsChart: `<div class="flex flex-wrap items-center gap-4"><label class="text-sm font-semibold text-slate-700">Highlight:</label><select id="manipulative_hundredsChartHighlight_{SIDE}" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 text-sm rounded-lg"><option value="none">None</option><option value="prime">Primes</option><option value="even">Evens</option><option value="odd">Odds</option><option value="multiples">Multiples of</option><option value="factors">Factors of</option></select><input type="number" id="manipulative_hundredsChartNumberInput_{SIDE}" class="w-20 p-1 border-2 border-slate-300 rounded-lg text-center hidden" value="2" min="1" max="100"></div>`,
        factorTree: `<div class="flex flex-col items-center gap-2"><label class="text-sm font-semibold text-slate-700">Number to Factorize:</label><input type="number" id="manipulative_factorTreeNumberInput_{SIDE}" class="w-24 p-1 border-2 border-slate-300 rounded-lg text-center" value="12" min="2" max="1000"><button type="button" id="manipulative_factorizeButton_{SIDE}" class="mt-2 bg-blue-500 text-white font-semibold py-1 px-3 rounded-lg text-sm">Factorize</button></div>`,
        multiplicationNumberBond: `<div class="flex items-center gap-2"><label class="text-sm font-semibold text-slate-700">Factor 1:</label><input type="number" id="manipulative_multFactor1Input_{SIDE}" class="w-24 p-1 border-2 border-slate-300 rounded-lg text-center" value="2" min="0"><span class="text-xl font-bold text-slate-700 mx-2">x</span><label class="text-sm font-semibold text-slate-700">Factor 2:</label><input type="number" id="manipulative_multFactor2Input_{SIDE}" class="w-24 p-1 border-2 border-slate-300 rounded-lg text-center" value="6" min="0"></div>`,
        additionNumberBond: `<div class="flex items-center gap-2"><label class="text-sm font-semibold text-slate-700">Addend 1:</label><input type="number" id="manipulative_addAddend1Input_{SIDE}" class="w-24 p-1 border-2 border-slate-300 rounded-lg text-center" value="5" min="0"><span class="text-xl font-bold text-slate-700 mx-2">+</span><label class="text-sm font-semibold text-slate-700">Addend 2:</label><input type="number" id="manipulative_addAddend2Input_{SIDE}" class="w-24 p-1 border-2 border-slate-300 rounded-lg text-center" value="3" min="0"></div>`,
    };

    // --- HELPER FUNCTIONS ---
    function showMessage(message, duration = 3000) { 
        if (messageBox) {
            messageBox.textContent = message; 
            messageBox.style.display = 'block'; 
            setTimeout(() => { messageBox.style.display = 'none'; }, duration); 
        }
    }

    const clamp = (min, val, max) => Math.max(min, Math.min(val, max));
    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
    const lcm = (a, b) => (a * b) / gcd(a, b);

    // --- CLEANUP FUNCTIONS ---
    function cleanupEventListeners() {
        activeListeners.forEach(({ target, type, handler }) => {
            if (target && target.removeEventListener) {
                target.removeEventListener(type, handler);
            }
        });
        activeListeners = [];
    }

    function clear3DScene() { 
        if (animationFrameId) { 
            cancelAnimationFrame(animationFrameId); 
            animationFrameId = null; 
        } 
        if (scene) { 
            scene.traverse((object) => { 
                if (!object.isMesh && !object.isLine) return; 
                if (object.geometry) object.geometry.dispose(); 
                if (object.material) { 
                    if (Array.isArray(object.material)) { 
                        object.material.forEach(material => material.dispose()); 
                    } else { 
                        object.material.dispose(); 
                    } 
                } 
            }); 
            scene.clear(); 
        } 
        labels.forEach(label => { 
            if (label.element && label.element.parentNode) { 
                label.element.parentNode.removeChild(label.element); 
            } 
        }); 
        labels = []; 
        if (renderer) renderer.dispose(); 
        if (labelRenderer && labelRenderer.domElement.parentNode) { 
            labelRenderer.domElement.parentNode.removeChild(labelRenderer.domElement); 
        } 
        if (controls) controls.dispose(); 
    }

    function clear2DCanvas() { 
        if (ctx2D && mathCanvas2D) { 
            ctx2D.clearRect(0, 0, mathCanvas2D.width, mathCanvas2D.height); 
        } 
        if (shapeDisplay2D) {
            const existingLabels = shapeDisplay2D.querySelectorAll('.dimension-label-2d'); 
            existingLabels.forEach(label => label.remove()); 
        }
    }

    function clearCanvas(canvas, context) { 
        if (context && canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height); 
            context.fillStyle = '#FFFFFF'; 
            context.fillRect(0, 0, canvas.width, canvas.height); 
        }
    }

    // --- DRAWING & CALCULATION FUNCTIONS ---
    function frameObjectInView(object, camera, containerWidth, containerHeight, fillFactor = 0.8) { 
        const box = new THREE.Box3().setFromObject(object); 
        const sphere = box.getBoundingSphere(new THREE.Sphere()); 
        const center = sphere.center; 
        const radius = sphere.radius; 
        const fov = camera.fov * (Math.PI / 180); 
        const distance = (radius / (Math.sin(fov / 2))) / fillFactor; 
        camera.position.copy(center); 
        camera.position.z = center.z + distance; 
        camera.lookAt(center); 
        if (controls) { 
            controls.target.copy(center); 
            controls.update(); 
        } 
    }

    function create2DLabel(text, x, y, parentElement, options = {}) { 
        const element = document.createElement('div'); 
        element.className = 'dimension-label-2d'; 
        element.style.display = 'block'; 
        element.innerHTML = text; 
        element.style.left = `${x}px`; 
        element.style.top = `${y}px`; 
        if (options.color) element.style.color = options.color; 
        if (options.backgroundColor) element.style.backgroundColor = options.backgroundColor; 
        parentElement.appendChild(element); 
    }

    function drawSimpleAngle(angle) { 
        clear2DCanvas(); 
        const container = shapeDisplay2D; 
        if (!container || !ctx2D || !mathCanvas2D) return; 
        if (isNaN(angle) || angle < 0 || angle > 360) { 
            showMessage("Angle must be between 0 and 360.", 3000); 
            return; 
        } 
        mathCanvas2D.width = container.clientWidth; 
        mathCanvas2D.height = container.clientHeight; 
        const canvasWidth = mathCanvas2D.width; 
        const canvasHeight = mathCanvas2D.height; 
        const centerX = canvasWidth / 2; 
        const centerY = canvasHeight / 2; 
        const rayLength = Math.min(canvasWidth, canvasHeight) / 3; 
        const angleRad = -angle * Math.PI / 180; 
        ctx2D.strokeStyle = colors.main; 
        ctx2D.lineWidth = 3; 
        ctx2D.beginPath(); 
        ctx2D.moveTo(centerX, centerY); 
        ctx2D.lineTo(centerX + rayLength, centerY); 
        ctx2D.stroke(); 
        const endX = centerX + rayLength * Math.cos(angleRad); 
        const endY = centerY + rayLength * Math.sin(angleRad); 
        ctx2D.beginPath(); 
        ctx2D.moveTo(centerX, centerY); 
        ctx2D.lineTo(endX, endY); 
        ctx2D.stroke(); 
        ctx2D.beginPath(); 
        ctx2D.arc(centerX, centerY, rayLength / 3, 0, angleRad, true); 
        ctx2D.strokeStyle = colors.primaryBlue; 
        ctx2D.lineWidth = 2; 
        ctx2D.stroke(); 
        const labelRadius = rayLength / 2.5; 
        const labelAngle = -angle / 2 * Math.PI / 180; 
        const labelX = centerX + labelRadius * Math.cos(labelAngle); 
        const labelY = centerY + labelRadius * Math.sin(labelAngle); 
        create2DLabel(`${angle}°`, labelX, labelY, container, { color: 'white', backgroundColor: 'rgba(0, 123, 255, 0.8)' }); 
    }

    function calculateSimpleAngleSteps(angle) { 
        if (isNaN(angle) || angle < 0 || angle > 360) return ["Error: Angle must be between 0 and 360."]; 
        let type = "Reflex"; 
        if (angle === 0) type = "Zero"; 
        else if (angle < 90) type = "Acute"; 
        else if (angle === 90) type = "Right"; 
        else if (angle < 180) type = "Obtuse"; 
        else if (angle === 180) type = "Straight"; 
        else if (angle === 360) type = "Complete"; 
        return [ 
            `An angle is the figure formed by two rays, called the sides of the angle, sharing a common endpoint, called the vertex.`, 
            ``, 
            `The input angle is $${angle}^{\\circ}$`, 
            `This is a(n) <b>${type}</b> angle.` 
        ]; 
    }

    // --- ANIMATION & EVENT HANDLERS ---
    function animate3D() { 
        animationFrameId = requestAnimationFrame(animate3D); 
        if (shapeDisplayFullWidth && shapeDisplayFullWidth.classList.contains('hidden-mode')) return; 
        if (controls) controls.update(); 
        if (renderer && scene && camera) renderer.render(scene, camera); 
        if (labelRenderer && scene && camera) labelRenderer.render(scene, camera); 
    }

    function onWindowResize() { 
        setTimeout(handleDraw, 150); 
    }

    function handleModeChange() {
        if (modeSelector) {
            currentMode = modeSelector.value;
            pixelsPerUnit = 50;
            setupInputsForMode(currentMode);
        }
    }

    // --- MASTER CONTROL FUNCTIONS ---
    function setupInputsForMode(mode) {
        cleanupEventListeners();
        const isManipulative = manipulativeModes.includes(mode);
        
        // Hide all major layouts first
        if (oldToolLayout) oldToolLayout.classList.add('hidden');
        if (newToolLayout) newToolLayout.classList.add('hidden');
        if (manipulativeLayout) manipulativeLayout.classList.add('hidden');
        if (dimensionInputsInline) dimensionInputsInline.innerHTML = ''; // Clear old inputs
        
        // Show the correct major layout and delegate setup
        if (isManipulative) {
            if (manipulativeLayout) manipulativeLayout.classList.remove('hidden');
            manipulative_handleMasterModeChange();     
        } else {
            if (oldToolLayout) oldToolLayout.classList.toggle('hidden', newCanvasModes.includes(mode));
            if (newToolLayout) newToolLayout.classList.toggle('hidden', !newCanvasModes.includes(mode));
            if (oldToolLayout) oldToolLayout.classList.toggle('layout-side-by-side', sideBySideModes.includes(mode));
            
            if (graphingInputsPanel) graphingInputsPanel.innerHTML = '';
            if (menuToggleBtn) {
                menuToggleBtn.classList.add('toggle-on');
                menuToggleBtn.classList.remove('toggle-off');
            }
            if (menuToggleDot) menuToggleDot.classList.add('dot-on');
            
            if (newCanvasModes.includes(mode)) {
                if (answerToggleContainer) answerToggleContainer.classList.add('hidden');
                if (zoomControls) zoomControls.classList.remove('hidden');
                if (graphingInputsPanel) graphingInputsPanel.classList.remove('panel-hidden');
                if (graphingCanvasWrapper) graphingCanvasWrapper.classList.remove('canvas-expanded');
                
                switch (mode) {
                    case 'graphingCalculator':
                        if (graphingInputsPanel) graphingInputsPanel.innerHTML = inputTemplates.graphingCalculatorInputs || '';
                        const equationLinesContainer = document.getElementById('equationLinesContainer');
                        if (equationLinesContainer) { equationLinesContainer.innerHTML = ''; }
                        addGraphLineInput('y = 0.5x + 1');
                        addGraphLineInput('(1, 2)');
                        addGraphLineInput();
                        const addLineButton = document.createElement('button');
                        addLineButton.textContent = 'Add Line';
                        addLineButton.className = 'bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-600 transition-transform transform hover:scale-105 active:scale-100 shadow-md text-sm md:text-base mt-2';
                        addLineButton.onclick = () => addGraphLineInput();
                        if (graphingInputsPanel) graphingInputsPanel.appendChild(addLineButton);
                        break;
                    case 'shapeTransformationTool':
                        if (graphingInputsPanel) graphingInputsPanel.innerHTML = inputTemplates.shapeTransformationToolInputs || '';
                        const shapeToolInputs = ['polygonInput', 'translateX', 'translateY', 'rotateAngle', 'rotateOriginX', 'rotateOriginY'];
                        shapeToolInputs.forEach(id => { 
                            const element = document.getElementById(id); 
                            if (element) { 
                                const handler = handleDraw;
                                element.addEventListener('input', handler); 
                                activeListeners.push({ target: element, type: 'input', handler });
                            } 
                        });
                        document.querySelectorAll('input[name="flipAxis"]').forEach(radio => { 
                            const handler = handleDraw;
                            radio.addEventListener('change', handler); 
                            activeListeners.push({ target: radio, type: 'change', handler });
                        });
                        
                        // Quick shape buttons
                        const quickShapeButtons = [
                            { id: 'squareQuickShape', coords: quickShapeCoordinates.square },
                            { id: 'triangleQuickShape', coords: quickShapeCoordinates.triangle },
                            { id: 'rectangleQuickShape', coords: quickShapeCoordinates.rectangle },
                            { id: 'rhombusQuickShape', coords: quickShapeCoordinates.rhombus }
                        ];
                        
                        quickShapeButtons.forEach(({ id, coords }) => {
                            const btn = document.getElementById(id);
                            if (btn) {
                                const handler = () => { 
                                    const polygonInput = document.getElementById('polygonInput');
                                    if (polygonInput) {
                                        polygonInput.value = coords; 
                                        originalShapeVertices = parseCoordinates(coords); 
                                        handleDraw(); 
                                    }
                                };
                                btn.addEventListener('click', handler);
                                activeListeners.push({ target: btn, type: 'click', handler });
                            }
                        });
                        
                        const applyBtn = document.getElementById('applyShapeTransform');
                        if (applyBtn) {
                            const handler = handleDraw;
                            applyBtn.addEventListener('click', handler);
                            activeListeners.push({ target: applyBtn, type: 'click', handler });
                        }
                        
                        const resetBtn = document.getElementById('resetShapeTransform');
                        if (resetBtn) {
                            const handler = () => { 
                                const inputs = ['translateX', 'translateY', 'rotateAngle', 'rotateOriginX', 'rotateOriginY'];
                                inputs.forEach(id => {
                                    const el = document.getElementById(id);
                                    if (el) el.value = id.includes('Origin') ? '' : '0';
                                });
                                const flipNone = document.getElementById('flipNone');
                                if (flipNone) flipNone.checked = true;
                                currentShapeVertices = []; 
                                originalShapeVertices = []; 
                                const polygonInput = document.getElementById('polygonInput');
                                if (polygonInput) polygonInput.value = "(1,1),(2,1),(2,2),(1,2)"; 
                                handleDraw(); 
                            };
                            resetBtn.addEventListener('click', handler);
                            activeListeners.push({ target: resetBtn, type: 'click', handler });
                        }
                        break;
                }
                
                zoomInButton = document.getElementById('zoomInButton');
                zoomOutButton = document.getElementById('zoomOutButton');
                if (zoomInButton) {
                    const handler = zoomGraph(1.2);
                    zoomInButton.onclick = handler;
                }
                if (zoomOutButton) {
                    const handler = zoomGraph(1 / 1.2);
                    zoomOutButton.onclick = handler;
                }
            } else {
                if (answerToggleContainer) answerToggleContainer.classList.remove('hidden');
                if (zoomControls) zoomControls.classList.add('hidden');
                if (shapeDisplayFullWidth) shapeDisplayFullWidth.classList.add('hidden-mode');
                if (shapeDisplay2D) shapeDisplay2D.classList.add('hidden-mode');
                if (equationDisplayContainer) equationDisplayContainer.classList.add('hidden-mode');
                
                const is3DMode = mode.includes('volumeOf') || (mode.includes('surfaceAreaOf') && !mode.includes('netOf'));
                const is2DMode = mode.includes('netOf') || ['simpleAngle', 'correspondingAngles', 'areaOfRectangle', 'perimeterOfRectangle', 'areaOfTriangle', 'perimeterOfTriangle', 'areaOfCircle', 'circumferenceOfCircle'].includes(mode);
                
                if (is3DMode && shapeDisplayFullWidth) shapeDisplayFullWidth.classList.remove('hidden-mode');
                else if (is2DMode && shapeDisplay2D) shapeDisplay2D.classList.remove('hidden-mode');
                else if (equationDisplayContainer) equationDisplayContainer.classList.remove('hidden-mode');
                
                if (calculationStepsColumn) calculationStepsColumn.classList.toggle('hidden-mode', visualDisplayOnlyModes.includes(mode));
                
                if (dimensionInputsInline) dimensionInputsInline.innerHTML = inputTemplates[mode] || '';
                
                if (dimensionInputsInline) {
                    dimensionInputsInline.querySelectorAll('input, textarea, select').forEach(input => {
                        const handler = handleDraw;
                        input.addEventListener('input', handler);
                        activeListeners.push({ target: input, type: 'input', handler });
                    });
                }
                
                if (mode === 'tableEquation') {
                    const tableContainer = document.getElementById('table-container');
                    function addRow(xVal = '', yVal = '') {
                        if (!tableContainer) return;
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'flex items-center gap-2 mt-2';
                        rowDiv.innerHTML = `<label class="text-sm font-semibold text-slate-700">x:</label><input type="number" value="${xVal}" class="table-x w-16 p-1 border-2 border-slate-300 rounded-lg text-center"><label class="text-sm font-semibold text-slate-700">y:</label><input type="number" value="${yVal}" class="table-y w-16 p-1 border-2 border-slate-300 rounded-lg text-center"><button class="remove-table-row bg-red-500 text-white font-bold py-1 px-2 rounded-lg text-xs">-</button>`;
                        tableContainer.appendChild(rowDiv);
                        
                        const removeHandler = () => { rowDiv.remove(); handleDraw(); };
                        const removeBtn = rowDiv.querySelector('.remove-table-row');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', removeHandler);
                            activeListeners.push({ target: removeBtn, type: 'click', handler: removeHandler });
                        }
                        
                        rowDiv.querySelectorAll('input').forEach(input => {
                            const inputHandler = handleDraw;
                            input.addEventListener('input', inputHandler);
                            activeListeners.push({ target: input, type: 'input', handler: inputHandler });
                        });
                    }
                    
                    const addTableRowBtn = document.getElementById('add-table-row');
                    if (addTableRowBtn) {
                        const addHandler = () => addRow();
                        addTableRowBtn.addEventListener('click', addHandler);
                        activeListeners.push({ target: addTableRowBtn, type: 'click', handler: addHandler });
                    }
                    addRow(3, 9); 
                    addRow(5, 15);
                }
                
                if (['lineGraph', 'barGraph', 'pictograph'].includes(mode)) {
                    const container = document.getElementById('graph-data-container');
                    let rowHtml = '';
                    switch(mode) {
                        case 'lineGraph': 
                            rowHtml = `<div class="flex items-center gap-2 mt-2"><label>Year:</label><input type="text" class="graph-label w-24 p-1 border-2 rounded-lg text-center" value="2023"><label>Value:</label><input type="number" class="graph-value w-16 p-1 border-2 rounded-lg text-center" value="10"><button class="remove-row-btn bg-red-500 text-white font-bold py-1 px-2 rounded-lg text-xs">-</button></div>`; 
                            break;
                        case 'barGraph': 
                        case 'pictograph': 
                            rowHtml = `<div class="flex items-center gap-2 mt-2"><label>Label:</label><input type="text" class="graph-label w-24 p-1 border-2 rounded-lg" value="Category"><label>Value:</label><input type="number" class="graph-value w-16 p-1 border-2 rounded-lg text-center" value="10"><button class="remove-row-btn bg-red-500 text-white font-bold py-1 px-2 rounded-lg text-xs">-</button></div>`; 
                            break;
                    }
                    
                    const addRow = () => { 
                        if (!container) return;
                        const rowDiv = document.createElement('div'); 
                        rowDiv.innerHTML = rowHtml; 
                        rowDiv.querySelectorAll('input').forEach(i => {
                            const inputHandler = handleDraw;
                            i.addEventListener('input', inputHandler);
                            activeListeners.push({ target: i, type: 'input', handler: inputHandler });
                        }); 
                        const removeBtn = rowDiv.querySelector('.remove-row-btn');
                        if (removeBtn) {
                            const removeHandler = () => { rowDiv.remove(); handleDraw(); };
                            removeBtn.addEventListener('click', removeHandler);
                            activeListeners.push({ target: removeBtn, type: 'click', handler: removeHandler });
                        }
                        container.appendChild(rowDiv); 
                    };
                    
                    const addGraphRowBtn = document.getElementById('add-graph-row');
                    if (addGraphRowBtn) {
                        const addHandler = addRow;
                        addGraphRowBtn.addEventListener('click', addHandler);
                        activeListeners.push({ target: addGraphRowBtn, type: 'click', handler: addHandler });
                    }
                    addRow(); 
                    if(mode === 'lineGraph') { addRow(); addRow(); }
                }
            }
        }
        handleDraw();
    }

    function handleDraw() {
        const mode = currentMode;
        if (manipulativeModes.includes(mode)) {
            manipulative_handleDraw();
            return;
        }
        
        if (newCanvasModes.includes(mode)) {
            const parent = mathCanvas ? mathCanvas.parentElement : null;
            if (parent && mathCanvas && (mathCanvas.width !== parent.clientWidth || mathCanvas.height !== parent.clientHeight)) {
                mathCanvas.width = parent.clientWidth;
                mathCanvas.height = parent.clientHeight;
            }
            
            switch (mode) {
                case 'graphingCalculator':
                    let graphInputs = [];
                    const container = document.getElementById('equationLinesContainer');
                    if (container) {
                        Array.from(container.children).forEach(lineDiv => {
                            const eqInput = lineDiv.querySelector('input[type="text"]');
                            const colorInput = lineDiv.querySelector('input[type="color"]');
                            if (eqInput && eqInput.value.trim() !== '') {
                                graphInputs.push({ value: eqInput.value.trim(), color: colorInput ? colorInput.value : '#000000' });
                            }
                        });
                    }
                    drawGraphingCalculator(graphInputs, pixelsPerUnit);
                    break;
                case 'shapeTransformationTool':
                    drawShapeTransformationTool();
                    break;
            }
        } else {
            let stepsToDisplay = [];
            let displayContent = '';
            if (stepsContentContainer) stepsContentContainer.innerHTML = '';
            if (equationDisplay) equationDisplay.innerHTML = '';
            
            try {
                switch (mode) {
                    case 'simpleAngle': 
                        const angle = parseFloat(document.getElementById('angleValue')?.value);
                        drawSimpleAngle(angle); 
                        stepsToDisplay = calculateSimpleAngleSteps(angle); 
                        break;
                    // Add other cases as needed
                }
            } catch (e) {
                stepsToDisplay = [`Error: ${e.message}`];
            }
            
            if (displayContent && equationDisplay) {
                equationDisplay.innerHTML = displayContent;
            }
            
            if (stepsContentContainer) {
                stepsContentContainer.innerHTML = stepsToDisplay.map((step, index, arr) => {
                    const isFinal = index === arr.length - 1 && !step.startsWith("Error") && !step.includes("solutions");
                    const colorClass = isFinal ? 'text-green-600' : (step.startsWith("Error") ? 'text-red-500' : 'text-slate-800');
                                        const finalClass = isFinal ? 'font-bold' : 'font-semibold';
                    return `<p class="text-5xl my-1 text-left ${colorClass} ${finalClass}">${step}</p>`;
                }).join('');
            }
            
            if (mode === 'longDivision') {
                const divisionCanvas = document.getElementById('divisionCanvas');
                if (divisionCanvas) {
                    const dividend = parseInt(dimensionInputsInline.querySelector('#dividend')?.value, 10);
                    const divisor = parseInt(dimensionInputsInline.querySelector('#divisor')?.value, 10);
                    const divisionCtx = divisionCanvas.getContext('2d');
                    drawLongDivision(dividend, divisor, divisionCanvas, divisionCtx);
                }
            }
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([equationDisplay, stepsContentContainer, dimensionInputsInline]).catch(err => console.error('MathJax typeset error:', err));
            }
        }
    }

    // --- INITIALIZATION & EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        initializeDOM();
        modeSelector.addEventListener('change', handleModeChange);
        window.addEventListener('resize', onWindowResize);

        menuToggleBtn.addEventListener('click', () => {
            if (manipulativeModes.includes(currentMode)) {
                manipulative_handleMenuToggle();
            } else if (newCanvasModes.includes(currentMode)) {
                const isPanelHidden = graphingInputsPanel.classList.toggle('panel-hidden');
                graphingCanvasWrapper.classList.toggle('canvas-expanded', isPanelHidden);
                menuToggleBtn.classList.toggle('toggle-on', !isPanelHidden);
                menuToggleBtn.classList.toggle('toggle-off', isPanelHidden);
                menuToggleDot.classList.toggle('dot-on', !isPanelHidden);
                setTimeout(() => { handleDraw(); }, 300);
            } else {
                const isHidden = menuControls.classList.toggle('hidden');
                menuToggleBtn.classList.toggle('toggle-on', !isHidden);
                menuToggleBtn.classList.toggle('toggle-off', isHidden);
                menuToggleDot.classList.toggle('dot-on', !isHidden);
            }
        });

        answerToggleBtn.addEventListener('click', () => {
            if (manipulativeModes.includes(currentMode)) {
                manipulative_handleAnswerToggle();
            } else {
                const isHidden = calculationStepsColumn.classList.toggle('hidden-mode');
                answerToggleBtn.classList.toggle('toggle-on', !isHidden);
                answerToggleBtn.classList.toggle('toggle-off', isHidden);
                answerToggleDot.classList.toggle('dot-on', !isHidden);
                setTimeout(() => { handleDraw(); }, 150);
            }
        });
        
        manipulative_initialize();
        setupInputsForMode(currentMode);
    });

    // --- MANIPULATIVE MACHINE SCRIPT (RENAMED) ---
    function manipulative_hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }

    function manipulative_lightenColor(hex, percent) {
        const rgb = manipulative_hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 + percent/100;
        return `rgb(${Math.min(255,rgb.r*factor)},${Math.min(255,rgb.g*factor)},${Math.min(255,rgb.b*factor)})`;
    }

    function manipulative_darkenColor(hex, percent) {
        const rgb = manipulative_hexToRgb(hex);
        if (!rgb) return hex;
        const factor = 1 - percent/100;
        return `rgb(${Math.max(0,rgb.r*factor)},${Math.max(0,rgb.g*factor)},${Math.max(0,rgb.b*factor)})`;
    }

    function manipulative_isPrime(num) {
        if (num <= 1) return false;
        for (let i = 2; i <= Math.sqrt(num); i++) {
            if (num % i === 0) return false;
        }
        return true;
    }

    function manipulative_getFactors(num) {
        const factors = new Set();
        for (let i = 1; i <= Math.sqrt(num); i++) {
            if (num % i === 0) {
                factors.add(i);
                factors.add(num / i);
            }
        }
        return Array.from(factors).sort((a, b) => a - b);
    }

    function manipulative_getPrimeFactorsList(n) {
        let factors = [], tempN = n;
        for (let i = 2; i * i <= tempN; i++) {
            while (tempN % i === 0) {
                factors.push(i);
                tempN /= i;
            }
        }
        if (tempN > 1) {
            factors.push(tempN);
        }
        return factors;
    }

    function manipulative_renderAlgebraTile(ctx_param, tile) {
        if (!ctx_param) return;
        const {x, y, width, height, color, label} = tile;
        ctx_param.save();
        ctx_param.translate(x, y);
        ctx_param.beginPath();
        ctx_param.rect(-width / 2, -height / 2, width, height);
        ctx_param.fillStyle = color;
        ctx_param.fill();
        ctx_param.strokeStyle = manipulative_mainOutlineColor;
        ctx_param.lineWidth = manipulative_mainOutlineWidth;
        ctx_param.stroke();
        ctx_param.fillStyle = 'white';
        ctx_param.font = `bold ${Math.min(width, height) * 0.5}px Montserrat`;
        ctx_param.textAlign = 'center';
        ctx_param.textBaseline = 'middle';
        ctx_param.fillText(label, 0, 0);
        ctx_param.restore();
    }

    function manipulative_renderUnitCube(ctx_param, cube) {
        if(!ctx_param)return;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_baseTenTransparency;
        ctx_param.translate(cube.x,cube.y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        const faceSize=cube.size;
        const po=faceSize*manipulative_DEPTH_PERSPECTIVE_RATIO;
        ctx_param.beginPath();
        ctx_param.fillStyle=cube.color;
        ctx_param.rect(-faceSize/2,-faceSize/2,faceSize,faceSize);
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_lightenColor(cube.color,20);
        ctx_param.moveTo(-faceSize/2,-faceSize/2);
        ctx_param.lineTo(-faceSize/2+po,-faceSize/2-po);
        ctx_param.lineTo(faceSize/2+po,-faceSize/2-po);
        ctx_param.lineTo(faceSize/2,-faceSize/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_darkenColor(cube.color,20);
        ctx_param.moveTo(faceSize/2,-faceSize/2);
        ctx_param.lineTo(faceSize/2+po,-faceSize/2-po);
        ctx_param.lineTo(faceSize/2+po,faceSize/2-po);
        ctx_param.lineTo(faceSize/2,faceSize/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.restore();
    }

    function manipulative_renderRod(ctx_param, rodObject) {
        if(!ctx_param)return;
        const{x,y,width:w,height:h,color:c,depth:d}=rodObject;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_baseTenTransparency;
        ctx_param.translate(x,y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        const po=d*manipulative_DEPTH_PERSPECTIVE_RATIO;
        const segW=w/10;
        ctx_param.beginPath();
        ctx_param.fillStyle=c;
        ctx_param.rect(-w/2,-h/2,w,h);
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.strokeStyle=manipulative_internalLineColor;
        ctx_param.lineWidth=manipulative_internalLineWidth;
        for(let k=1;k<10;k++){
            const lx=-w/2+k*segW;
            ctx_param.beginPath();
            ctx_param.moveTo(lx,-h/2);
            ctx_param.lineTo(lx,h/2);
            ctx_param.stroke();
        }
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_lightenColor(c,20);
        ctx_param.moveTo(-w/2,-h/2);
        ctx_param.lineTo(-w/2+po,-h/2-po);
        ctx_param.lineTo(w/2+po,-h/2-po);
        ctx_param.lineTo(w/2,-h/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        for(let k=1;k<10;k++){
            const p1x=-w/2+k*segW,p1y=-h/2,p2x=-w/2+po+k*segW,p2y=-h/2-po;
            ctx_param.beginPath();
            ctx_param.moveTo(p1x,p1y);
            ctx_param.lineTo(p2x,p2y);
            ctx_param.stroke();
        }
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_darkenColor(c,20);
        ctx_param.moveTo(w/2,-h/2);
        ctx_param.lineTo(w/2+po,-h/2-po);
        ctx_param.lineTo(w/2+po,h/2-po);
        ctx_param.lineTo(w/2,h/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.restore();
    }

    function manipulative_renderFlat(ctx_param, flatObject) {
        if(!ctx_param)return;
        const{x,y,sideLength:s,thickness:th,color:c}=flatObject;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_baseTenTransparency;
        ctx_param.translate(x,y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        const po=th*manipulative_DEPTH_PERSPECTIVE_RATIO;
        const segS=s/10;
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_lightenColor(c,15);
        ctx_param.moveTo(-s/2,-s/2);
        ctx_param.lineTo(-s/2+po,-s/2-po);
        ctx_param.lineTo(s/2+po,-s/2-po);
        ctx_param.lineTo(s/2,-s/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_darkenColor(c,15);
        ctx_param.moveTo(s/2,-s/2);
        ctx_param.lineTo(s/2+po,-s/2-po);
        ctx_param.lineTo(s/2+po,s/2-po);
        ctx_param.lineTo(s/2,s/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=c;
        ctx_param.rect(-s/2,-s/2,s,s);
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.strokeStyle=manipulative_internalLineColor;
        ctx_param.lineWidth=manipulative_internalLineWidth;
        for(let i=1;i<10;i++){
            const l=-s/2+i*segS;
            ctx_param.beginPath();
            ctx_param.moveTo(l,-s/2);
            ctx_param.lineTo(l,s/2);
            ctx_param.stroke();
            ctx_param.beginPath();
            ctx_param.moveTo(-s/2,l);
            ctx_param.lineTo(s/2,l);
            ctx_param.stroke();
        }
        ctx_param.restore();
    }

    function manipulative_renderBlock1000(ctx_param, blockObject) {
        if(!ctx_param)return;
        const{x,y,sideLength:s,color:c}=blockObject;
        const d=s;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_baseTenTransparency;
        ctx_param.translate(x,y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        const po=d*manipulative_DEPTH_PERSPECTIVE_RATIO;
        const seg=s/10;
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_lightenColor(c,20);
        ctx_param.moveTo(-s/2,-s/2);
        ctx_param.lineTo(-s/2+po,-s/2-po);
        ctx_param.lineTo(s/2+po,-s/2-po);
        ctx_param.lineTo(s/2,-s/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=manipulative_darkenColor(c,20);
        ctx_param.moveTo(s/2,-s/2);
        ctx_param.lineTo(s/2+po,-s/2-po);
        ctx_param.lineTo(s/2+po,s/2-po);
        ctx_param.lineTo(s/2,s/2);
        ctx_param.closePath();
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.fillStyle=c;
        ctx_param.rect(-s/2,-s/2,s,s);
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.strokeStyle=manipulative_internalLineColor;
        ctx_param.lineWidth=manipulative_internalLineWidth;
        for(let i=1;i<10;i++){
            ctx_param.beginPath();
            ctx_param.moveTo(-s/2+i*seg,-s/2);
            ctx_param.lineTo(-s/2+i*seg,s/2);
            ctx_param.stroke();
            ctx_param.beginPath();
            ctx_param.moveTo(-s/2,-s/2+i*seg);
            ctx_param.lineTo(s/2,-s/2+i*seg);
            ctx_param.stroke();
        }
        ctx_param.restore();
    }

    function manipulative_getEffectiveBlockDimensions(type, currentBaseSize) {
        let w_ratio,h_ratio,d_ratio;
        if(type==='block1000'){
            w_ratio=10;
            h_ratio=10;
            d_ratio=10;
        }else if(type==='flat'){
            w_ratio=10;
            h_ratio=10;
            d_ratio=1;
        }else if(type==='rod'){
            w_ratio=10;
            h_ratio=1;
            d_ratio=1;
        }else{
            w_ratio=1;
            h_ratio=1;
            d_ratio=1;
        }
        const currentBlockWidth=w_ratio*currentBaseSize;
        const currentBlockHeight=h_ratio*currentBaseSize;
        const currentBlockDepth=d_ratio*currentBaseSize;
        const effectiveVisualWidth=currentBlockWidth+(currentBlockDepth*manipulative_DEPTH_PERSPECTIVE_RATIO);
        const effectiveVisualHeight=currentBlockHeight+(currentBlockDepth*manipulative_DEPTH_PERSPECTIVE_RATIO);
        return{currentBlockWidth,currentBlockHeight,currentBlockDepth,effectiveVisualWidth,effectiveVisualHeight};
    }

    function manipulative_renderFractionStrip(ctx_param, strip) {
        if(!ctx_param)return;
        const{x,y,width,height,denominator,numerator,color,showNotation}=strip;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_geometricShapeTransparency;
        ctx_param.translate(x,y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        ctx_param.beginPath();
        ctx_param.rect(-width/2,-height/2,width,height);
        ctx_param.stroke();
        const segmentWidth=width/denominator;
        for(let i=0;i<denominator;i++){
            ctx_param.beginPath();
            ctx_param.rect(-width/2+i*segmentWidth,-height/2,segmentWidth,height);
            ctx_param.fillStyle=i<numerator?color:manipulative_fractionUnfilledColor;
            ctx_param.fill();
            ctx_param.stroke();
        }
        if(showNotation&&denominator>0){
            ctx_param.fillStyle=manipulative_mainOutlineColor;
            ctx_param.font=`${height*0.4}px Montserrat`;
            ctx_param.textAlign='center';
            ctx_param.textBaseline='middle';
            const labelText=`1/${denominator}`;
            for(let i=0;i<denominator;i++){
                ctx_param.fillText(labelText,-width/2+(i*segmentWidth)+(segmentWidth/2),0);
            }
        }
        ctx_param.restore();
    }

    function manipulative_renderFractionCircle(ctx_param, circle) {
        if(!ctx_param)return;
        const{x,y,radius,denominator,numerator,color,showNotation}=circle;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_geometricShapeTransparency;
        ctx_param.translate(x,y);
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        const anglePerSegment=(2*Math.PI)/denominator;
        for(let i=0;i<denominator;i++){
            ctx_param.beginPath();
            ctx_param.moveTo(0,0);
            ctx_param.arc(0,0,radius,i*anglePerSegment,(i+1)*anglePerSegment);
            ctx_param.closePath();
            ctx_param.fillStyle=i<numerator?color:manipulative_fractionUnfilledColor;
            ctx_param.fill();
            ctx_param.stroke();
        }
        if(showNotation&&denominator>0){
            ctx_param.fillStyle=manipulative_mainOutlineColor;
            ctx_param.font=`${radius*0.375}px Montserrat`;
            ctx_param.textAlign='center';
            ctx_param.textBaseline='middle';
            const labelText=`1/${denominator}`;
            for(let i=0;i<denominator;i++){
                const angle=(i*anglePerSegment)+(anglePerSegment/2);
                ctx_param.fillText(labelText,radius*0.65*Math.cos(angle),radius*0.65*Math.sin(angle));
            }
        }
        ctx_param.restore();
    }

    function manipulative_renderMultiplicationArray(ctx_param, array) {
        if(!ctx_param)return;
        const{x,y,cellSize,rows,cols,color}=array;
        ctx_param.save();
        ctx_param.globalAlpha=manipulative_geometricShapeTransparency;
        ctx_param.translate(x,y);
        const totalWidth=cols*cellSize;
        const totalHeight=rows*cellSize;
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth;
        ctx_param.beginPath();
        ctx_param.rect(-totalWidth/2,-totalHeight/2,totalWidth,totalHeight);
        ctx_param.fillStyle=color;
        ctx_param.fill();
        ctx_param.stroke();
        ctx_param.strokeStyle=manipulative_internalLineColor;
        ctx_param.lineWidth=manipulative_internalLineWidth;
        for(let i=1;i<rows;i++){
            ctx_param.beginPath();
            ctx_param.moveTo(-totalWidth/2,-totalHeight/2+i*cellSize);
            ctx_param.lineTo(totalWidth/2,-totalHeight/2+i*cellSize);
            ctx_param.stroke();
        }
        for(let i=1;i<cols;i++){
            ctx_param.beginPath();
            ctx_param.moveTo(-totalWidth/2+i*cellSize,-totalHeight/2);
            ctx_param.lineTo(-totalWidth/2+i*cellSize,totalHeight/2);
            ctx_param.stroke();
        }
        ctx_param.restore();
    }

    function manipulative_renderTenFrameOnCanvas(ctx_param, frame) {
        if(!ctx_param)return;
        const{x,y,cellSize,rows,cols,numDots}=frame;
        ctx_param.save();
        ctx_param.translate(x,y);
        const totalWidth=cols*cellSize;
        const totalHeight=rows*cellSize;
        for(let r=0;r<rows;r++){
            for(let c=0;c<cols;c++){
                const cellIndex=r*cols+c;
                const cellX=-totalWidth/2+c*cellSize;
                const cellY=-totalHeight/2+r*cellSize;
                ctx_param.beginPath();
                ctx_param.rect(cellX,cellY,cellSize,cellSize);
                ctx_param.fillStyle=manipulative_chartCellColor;
                ctx_param.fill();
                ctx_param.strokeStyle=manipulative_chartBorderColor;
                ctx_param.lineWidth=manipulative_internalLineWidth;
                ctx_param.stroke();
                if(cellIndex<numDots){
                    ctx_param.beginPath();
                    ctx_param.arc(cellX+cellSize/2,cellY+cellSize/2,cellSize*0.35,0,2*Math.PI);
                    ctx_param.fillStyle=manipulative_tenFrameDotColor;
                    ctx_param.fill();
                }
            }
        }
        ctx_param.restore();
    }

    function manipulative_renderHundredsChartOnCanvas(ctx_param, chart) {
        if(!ctx_param)return;
        const{x,y,cellSize,rows,cols,highlightType,highlightNumber}=chart;
        ctx_param.save();
        ctx_param.translate(x,y);
        const totalWidth=cols*cellSize;
        const totalHeight=rows*cellSize;
        for(let i=1;i<=100;i++){
            const r=Math.floor((i-1)/cols);
            const c=(i-1)%cols;
            const cellX=-totalWidth/2+c*cellSize;
            const cellY=-totalHeight/2+r*cellSize;
            let cellFillColor=manipulative_chartCellColor,textColor='#333';
            if(highlightType==='prime'&&manipulative_isPrime(i)){
                cellFillColor=manipulative_highlightPrimeColor;
            }else if(highlightType==='even'&&i%2===0){
                cellFillColor=manipulative_highlightEvenColor;
                textColor='white';
            }else if(highlightType==='odd'&&i%2!==0){
                cellFillColor=manipulative_highlightOddColor;
                textColor='white';
            }else if(highlightType==='multiples'&&highlightNumber>0&&i%highlightNumber===0){
                cellFillColor=manipulative_highlightMultipleColor;
                textColor='white';
            }else if(highlightType==='factors'&&highlightNumber>0&&highlightNumber%i===0){
                cellFillColor=manipulative_highlightFactorColor;
                textColor='white';
            }
            ctx_param.beginPath();
            ctx_param.rect(cellX,cellY,cellSize,cellSize);
            ctx_param.fillStyle=cellFillColor;
            ctx_param.fill();
            ctx_param.strokeStyle=manipulative_chartBorderColor;
            ctx_param.lineWidth=manipulative_internalLineWidth;
            ctx_param.stroke();
            ctx_param.fillStyle=textColor;
            ctx_param.font=`bold ${cellSize*0.4}px Montserrat`;
            ctx_param.textAlign='center';
            ctx_param.textBaseline='middle';
            ctx_param.fillText(i,cellX+cellSize/2,cellY+cellSize/2);
        }
        ctx_param.restore();
    }

    function manipulative_renderAnalogClock(ctx_param, clock) {
        if(!ctx_param)return;
        const{x,y,radius,hour,minute}=clock;
        ctx_param.save();
        ctx_param.translate(x,y);
        ctx_param.beginPath();
        ctx_param.arc(0,0,radius,0,2*Math.PI);
        ctx_param.fillStyle='white';
        ctx_param.fill();
        ctx_param.strokeStyle=manipulative_mainOutlineColor;
        ctx_param.lineWidth=manipulative_mainOutlineWidth*2;
        ctx_param.stroke();
        ctx_param.beginPath();
        ctx_param.arc(0,0,5,0,2*Math.PI);
        ctx_param.fillStyle=manipulative_mainOutlineColor;
        ctx_param.fill();
        ctx_param.font=`bold ${radius*0.15}px Montserrat`;
        ctx_param.textAlign='center';
        ctx_param.textBaseline='middle';
        for(let num=1;num<=12;num++){
            const angle=num*Math.PI/6;
            const numX=radius*0.85*Math.sin(angle);
            const numY=-radius*0.85*Math.cos(angle);
            ctx_param.fillText(num,numX,numY);
        }
        for(let i=0;i<60;i++){
            const angle=(i/60)*2*Math.PI;
            const startRadius=i%5===0?radius*0.9:radius*0.95;
            const endRadius=radius;
            ctx_param.beginPath();
            ctx_param.moveTo(startRadius*Math.sin(angle),-startRadius*Math.cos(angle));
            ctx_param.lineTo(endRadius*Math.sin(angle),-endRadius*Math.cos(angle));
            ctx_param.lineWidth=(i%5===0)?2:1;
            ctx_param.stroke();
        }
        const hourAngle=(hour%12+minute/60)*Math.PI/6;
        const minuteAngle=(minute/60)*2*Math.PI;
        ctx_param.beginPath();
        ctx_param.moveTo(0,0);
        ctx_param.rotate(hourAngle);
        ctx_param.lineTo(0,-radius*0.5);
        ctx_param.lineWidth=6;
        ctx_param.stroke();
        ctx_param.rotate(-hourAngle);
        ctx_param.beginPath();
        ctx_param.moveTo(0,0);
        ctx_param.rotate(minuteAngle);
        ctx_param.lineTo(0,-radius*0.8);
        ctx_param.lineWidth=4;
        ctx_param.stroke();
        ctx_param.rotate(-minuteAngle);
        ctx_param.restore();
    }

    function manipulative_findPrimeFactors(n) {
        if (n < 2) return { value: n, children: [] };
        const node = { value: n, children: [], isPrime: false };
        let tempN = n, foundFactor = false;
        for (let i = 2; i * i <= tempN; i++) {
            if (tempN % i === 0) {
                node.children.push(manipulative_findPrimeFactors(i));
                node.children.push(manipulative_findPrimeFactors(tempN / i));
                foundFactor = true;
                break;
            }
        }
        if (!foundFactor) {
            node.isPrime = true;
        }
        return node;
    }

    function manipulative_measureSubtreeLayout(node, baseNodeRadius, baseVerticalSpacing, baseHorizontalNodeGap) {
        if (node.children.length === 0) return { width: baseNodeRadius * 2, height: baseNodeRadius * 2 };
        const leftChildLayout = manipulative_measureSubtreeLayout(node.children[0], baseNodeRadius, baseVerticalSpacing, baseHorizontalNodeGap);
        const rightChildLayout = manipulative_measureSubtreeLayout(node.children[1], baseNodeRadius, baseVerticalSpacing, baseHorizontalNodeGap);
        const childrenTotalWidth = leftChildLayout.width + rightChildLayout.width + baseHorizontalNodeGap;
        const subtreeWidth = Math.max(baseNodeRadius * 2, childrenTotalWidth);
        const subtreeHeight = (baseNodeRadius * 2) + baseVerticalSpacing + Math.max(leftChildLayout.height, rightChildLayout.height);
        return { width: subtreeWidth, height: subtreeHeight };
    }

    function manipulative_drawFactorTreeRecursive(ctx, node, x, y, nodeRadius, verticalSpacing, horizontalGapBetweenSiblings) {
        manipulative_drawCircleNode(ctx, x, y, nodeRadius, manipulative_factorTreeNodeColor, node.value);
        if (node.children.length > 0) {
            const childY = y + verticalSpacing + nodeRadius * 2;
            const leftChildLayout = manipulative_measureSubtreeLayout(node.children[0], nodeRadius, verticalSpacing, horizontalGapBetweenSiblings);
            const rightChildLayout = manipulative_measureSubtreeLayout(node.children[1], nodeRadius, verticalSpacing, horizontalGapBetweenSiblings);
            const totalChildrenSpan = leftChildLayout.width + horizontalGapBetweenSiblings + rightChildLayout.width;
            const child1X = x - totalChildrenSpan / 2 + leftChildLayout.width / 2;
            const child2X = x + totalChildrenSpan / 2 - rightChildLayout.width / 2;
            ctx.beginPath();
            ctx.strokeStyle = manipulative_numberBondLineColor;
            ctx.lineWidth = manipulative_internalLineWidth;
            ctx.moveTo(x, y + nodeRadius);
            ctx.lineTo(child1X, childY - nodeRadius);
            ctx.moveTo(x, y + nodeRadius);
            ctx.lineTo(child2X, childY - nodeRadius);
            ctx.stroke();
            manipulative_drawFactorTreeRecursive(ctx, node.children[0], child1X, childY, nodeRadius, verticalSpacing, horizontalGapBetweenSiblings);
            manipulative_drawFactorTreeRecursive(ctx, node.children[1], child2X, childY, nodeRadius, verticalSpacing, horizontalGapBetweenSiblings);
        }
    }

    function manipulative_drawFactorTreeOnCanvas(canvasElement, numberToFactorize) {
        const ctx_param = canvasElement.getContext('2d');
        ctx_param.clearRect(0, 0, canvasElement.width, canvasElement.height);
        if (isNaN(numberToFactorize) || numberToFactorize < 2) return;
        const treeData = manipulative_findPrimeFactors(numberToFactorize);
        const baseNodeRadius = 30, baseVerticalSpacing = 20, baseHorizontalNodeGap = 15;
        const treeLayout = manipulative_measureSubtreeLayout(treeData, baseNodeRadius, baseVerticalSpacing, baseHorizontalNodeGap);
        canvasElement.width = treeLayout.width + manipulative_padding * 2;
        canvasElement.height = treeLayout.height + manipulative_padding * 2;
        requestAnimationFrame(() => {
            ctx_param.clearRect(0, 0, canvasElement.width, canvasElement.height);
            manipulative_drawFactorTreeRecursive(ctx_param, treeData, canvasElement.width / 2, baseNodeRadius + manipulative_padding, baseNodeRadius, baseVerticalSpacing, baseHorizontalNodeGap);
        });
    }

    function manipulative_drawCircleNode(ctx, x, y, radius, color, text) {
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = manipulative_mainOutlineColor;
        ctx.lineWidth = manipulative_mainOutlineWidth;
        ctx.stroke();
        ctx.fillStyle = manipulative_mainOutlineColor;
        ctx.font = `bold ${radius * 0.6}px Montserrat`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, x, y);
    }

    function manipulative_easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }

    // --- LAYOUT ENGINE & MASTER DRAWING ---
    function manipulative_layoutAndRenderManipulatives(currentBaseUnitSize, canvasWidth, itemsToRender, ctx_param = null, isDrawingPass = false, canvasContainer) {
        let currentY_visual_top = manipulative_padding, maxOverallDrawingHeight = manipulative_padding, rowsOfItems = [], currentRowItems = [], currentRowWidth = 0, currentRowMaxEffectiveVisualHeight = 0, initialPerspectiveOffset = 0;

        const has3DBlocks = itemsToRender.some(item => ['block1000', 'flat', 'rod', 'cube'].includes(item.type));

        if (has3DBlocks) {
            initialPerspectiveOffset = manipulative_getEffectiveBlockDimensions('block1000', currentBaseUnitSize).currentBlockDepth * manipulative_DEPTH_PERSPECTIVE_RATIO;
            currentY_visual_top += initialPerspectiveOffset;
            maxOverallDrawingHeight += initialPerspectiveOffset;
        }

        for (const item of itemsToRender) {
            let effectiveVisualWidth, effectiveVisualHeight;
            let manipulativeProps = {};

            if (['block1000', 'flat', 'rod', 'cube'].includes(item.type)) {
                const dims = manipulative_getEffectiveBlockDimensions(item.type, currentBaseUnitSize);
                effectiveVisualWidth = dims.effectiveVisualWidth;
                effectiveVisualHeight = dims.effectiveVisualHeight;
                manipulativeProps = { size: dims.currentBlockWidth, width: dims.currentBlockWidth, height: dims.currentBlockHeight, sideLength: dims.currentBlockWidth, thickness: dims.currentBlockDepth, depth: dims.currentBlockDepth };
            }
            else if (item.type === 'fractionStrip') {
                effectiveVisualWidth = currentBaseUnitSize * 35;
                effectiveVisualHeight = currentBaseUnitSize * 7;
                manipulativeProps = { width: effectiveVisualWidth, height: effectiveVisualHeight, ...item };
            }
            else if (item.type === 'fractionCircle') {
                effectiveVisualWidth = currentBaseUnitSize * 14;
                effectiveVisualHeight = currentBaseUnitSize * 14;
                manipulativeProps = { radius: effectiveVisualWidth / 2, ...item };
            }
            else if (item.type === 'multiplicationArray') {
                const cellSize = currentBaseUnitSize * 4;
                effectiveVisualWidth = item.cols * cellSize;
                effectiveVisualHeight = item.rows * cellSize;
                manipulativeProps = { cellSize, ...item };
            }
            else if (item.type === 'tenFrame') {
                const cellSize = currentBaseUnitSize * 5;
                effectiveVisualWidth = item.cols * cellSize;
                effectiveVisualHeight = item.rows * cellSize;
                manipulativeProps = { cellSize, ...item };
            }
            else if (item.type === 'hundredsChart') {
                const cellSize = currentBaseUnitSize * 5;
                effectiveVisualWidth = item.cols * cellSize;
                effectiveVisualHeight = item.rows * cellSize;
                manipulativeProps = { cellSize, ...item };
            }
            else if (item.type === 'algebraTile') {
                const xSide = (currentBaseUnitSize * 8) * 1.7, oneSide = (currentBaseUnitSize * 2) * 1.7;
                if (item.tileType === 'x2') {
                    effectiveVisualWidth = xSide;
                    effectiveVisualHeight = xSide;
                } else if (item.tileType === 'x') {
                    effectiveVisualWidth = xSide;
                    effectiveVisualHeight = oneSide;
                } else {
                    effectiveVisualWidth = oneSide;
                    effectiveVisualHeight = oneSide;
                }
                manipulativeProps = { width: effectiveVisualWidth, height: effectiveVisualHeight, ...item };
            }
            else {
                continue;
            }

            const itemWidthWithPadding = effectiveVisualWidth + manipulative_padding;

            if (currentRowItems.length > 0 && (currentRowWidth + itemWidthWithPadding - manipulative_padding) > (canvasWidth - 2 * manipulative_padding)) {
                rowsOfItems.push({ items: currentRowItems, width: currentRowWidth - manipulative_padding, height: currentRowMaxEffectiveVisualHeight });
                currentY_visual_top += currentRowMaxEffectiveVisualHeight + manipulative_padding;
                currentRowItems = [];
                currentRowWidth = 0;
                currentRowMaxEffectiveVisualHeight = 0;
            }

            currentRowItems.push({ item, effectiveVisualWidth, effectiveVisualHeight, manipulativeProps });
            currentRowWidth += itemWidthWithPadding;
            currentRowMaxEffectiveVisualHeight = Math.max(currentRowMaxEffectiveVisualHeight, effectiveVisualHeight);
        }

        if (currentRowItems.length > 0) {
            rowsOfItems.push({ items: currentRowItems, width: currentRowWidth - manipulative_padding, height: currentRowMaxEffectiveVisualHeight });
            maxOverallDrawingHeight = currentY_visual_top + currentRowMaxEffectiveVisualHeight;
        } else {
            maxOverallDrawingHeight = currentY_visual_top;
        }

        let currentDrawingY = manipulative_padding;
        if(has3DBlocks) currentDrawingY += initialPerspectiveOffset;

        for (const row of rowsOfItems) {
            const startX = (canvasWidth - row.width) / 2;
            let currentXInRow = startX;

            for (const itemInfo of row.items) {
                let yAdjust = (['block1000', 'flat', 'rod', 'cube'].includes(itemInfo.item.type)) ? manipulative_getEffectiveBlockDimensions(itemInfo.item.type, currentBaseUnitSize).currentBlockDepth * manipulative_DEPTH_PERSPECTIVE_RATIO / 2 + manipulative_getEffectiveBlockDimensions(itemInfo.item.type, currentBaseUnitSize).currentBlockHeight / 2 : itemInfo.effectiveVisualHeight / 2;

                if (isDrawingPass) {
                    const manipulativeObj = { ...itemInfo.item, ...itemInfo.manipulativeProps, x: currentXInRow + itemInfo.effectiveVisualWidth / 2, y: currentDrawingY + yAdjust };

                    if (manipulativeObj.type === 'cube') manipulative_renderUnitCube(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'rod') manipulative_renderRod(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'flat') manipulative_renderFlat(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'block1000') manipulative_renderBlock1000(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'fractionStrip') manipulative_renderFractionStrip(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'fractionCircle') manipulative_renderFractionCircle(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'multiplicationArray') manipulative_renderMultiplicationArray(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'tenFrame') manipulative_renderTenFrameOnCanvas(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'hundredsChart') manipulative_renderHundredsChartOnCanvas(ctx_param, manipulativeObj);
                    else if (manipulativeObj.type === 'algebraTile') manipulative_renderAlgebraTile(ctx_param, manipulativeObj);
                }
                currentXInRow += itemInfo.effectiveVisualWidth + manipulative_padding;
            }
            currentDrawingY += row.height + manipulative_padding;
        }

        return { totalContentWidth: Math.max(...rowsOfItems.map(r => r.width), 0) + manipulative_padding * 2, totalDrawingHeight: maxOverallDrawingHeight + manipulative_padding };
    }

    function manipulative_drawSingleManipulative() {
        const currentMode = manipulative_currentMasterMode;
        if (!manipulative_mathCanvas || !manipulative_ctx) return;
        manipulative_ctx.clearRect(0, 0, manipulative_mathCanvas.width, manipulative_mathCanvas.height);
        manipulative_mathCanvas.style.backgroundColor = 'transparent';

        if (currentMode === 'factorTree') {
            manipulative_drawFactorTreeOnCanvas(manipulative_mathCanvas, parseInt(document.getElementById('manipulative_factorTreeNumberInput_single')?.value) || 0);
            return;
        }

        if (currentMode === 'multiplicationNumberBond') {
            const f1 = parseInt(document.getElementById('manipulative_multFactor1Input_single')?.value) || 0, f2 = parseInt(document.getElementById('manipulative_multFactor2Input_single')?.value) || 0;
            manipulative_drawNumberBondOnCanvas(manipulative_mathCanvas, f1, f2, f1 * f2, '×', manipulative_multiplicationBondColor, false);
            return;
        }

        if (currentMode === 'additionNumberBond') {
            const a1 = parseInt(document.getElementById('manipulative_addAddend1Input_single')?.value) || 0, a2 = parseInt(document.getElementById('manipulative_addAddend2Input_single')?.value) || 0;
            manipulative_drawNumberBondOnCanvas(manipulative_mathCanvas, a1, a2, a1 + a2, '+', manipulative_additionBondColor, false);
            return;
        }

        if (currentMode === 'analogClock') {
            const hour = parseInt(document.getElementById('manipulative_clockHour_single')?.value) || 12;
            const minute = parseInt(document.getElementById('manipulative_clockMinute_single')?.value) || 0;
            const radius = Math.min(manipulative_mathCanvas.width, manipulative_mathCanvas.height) / 2 - manipulative_padding;
            manipulative_renderAnalogClock(manipulative_ctx, { x: manipulative_mathCanvas.width / 2, y: manipulative_mathCanvas.height / 2, radius, hour, minute });
            return;
        }

        if (currentMode === 'probabilitySpinner' || currentMode === 'diceRoller') {
            if (!manipulative_isAnimating.single) manipulative_drawProbabilityTool('single');
            return;
        }

        let itemsToRender = [];
        let totalItemCount = 0;

        if (currentMode === 'baseTenBlocks') {
            const q = {
                '1000': parseInt(document.getElementById('manipulative_block-1000_single')?.value) || 0,
                '100': parseInt(document.getElementById('manipulative_block-100_single')?.value) || 0,
                '10': parseInt(document.getElementById('manipulative_block-10_single')?.value) || 0,
                '1': parseInt(document.getElementById('manipulative_block-1_single')?.value) || 0
            };
            totalItemCount = Object.values(q).reduce((a, b) => a + b, 0);
            for (let i = 0; i < q['1000']; i++) itemsToRender.push({ type: 'block1000', color: manipulative_block1000Color });
            for (let i = 0; i < q['100']; i++) itemsToRender.push({ type: 'flat', color: manipulative_flatColor });
            for (let i = 0; i < q['10']; i++) itemsToRender.push({ type: 'rod', color: manipulative_rodColor });
            for (let i = 0; i < q['1']; i++) itemsToRender.push({ type: 'cube', color: manipulative_unitCubeColor });
        }
        else if (currentMode === 'algebraTiles') {
            const tiles = {
                'x2': { q: parseInt(document.getElementById(`manipulative_tile-x2_single`)?.value) || 0, c: manipulative_algebraTilePositiveX2Color, l: 'x²' },
                'x': { q: parseInt(document.getElementById(`manipulative_tile-x_single`)?.value) || 0, c: manipulative_algebraTilePositiveXColor, l: 'x' },
                '1': { q: parseInt(document.getElementById(`manipulative_tile-1_single`)?.value) || 0, c: manipulative_algebraTilePositiveOneColor, l: '1' },
                'neg-x2': { q: parseInt(document.getElementById(`manipulative_tile-neg-x2_single`)?.value) || 0, c: manipulative_algebraTileNegativeColor, l: '-x²' },
                'neg-x': { q: parseInt(document.getElementById(`manipulative_tile-neg-x_single`)?.value) || 0, c: manipulative_algebraTileNegativeColor, l: '-x' },
                'neg-1': { q: parseInt(document.getElementById(`manipulative_tile-neg-1_single`)?.value) || 0, c: manipulative_algebraTileNegativeColor, l: '-1' }
            };
            for (const [key, val] of Object.entries(tiles)) {
                for (let i = 0; i < val.q; i++) {
                    itemsToRender.push({ type: 'algebraTile', tileType: key.replace('neg-', ''), color: val.c, label: val.l });
                    totalItemCount++;
                }
            }
        }
        else if (currentMode === 'fractionStrips' || currentMode === 'fractionCircles') {
            const type = currentMode === 'fractionStrips' ? 'fractionStrip' : 'fractionCircle';
            const color = type === 'fractionStrip' ? manipulative_fractionStripColor : manipulative_fractionCircleColor;
            const container = document.getElementById('manipulative_' + type + 'InputsContainer_single');
            if (container) {
                Array.from(container.children).forEach(row => {
                    const num = parseInt(row.querySelector('.fraction-numerator')?.value) || 0, den = parseInt(row.querySelector('.fraction-denominator')?.value) || 1, showNotation = row.querySelector('.show-notation-checkbox')?.checked || false;
                    if (den > 0) {
                        itemsToRender.push({ type, numerator: num, denominator: den, color, showNotation });
                        totalItemCount++;
                    }
                });
            }
        }
        else if (currentMode === 'multiplicationArray') {
            const rows = parseInt(document.getElementById('manipulative_arrayRows_single')?.value) || 0, cols = parseInt(document.getElementById('manipulative_arrayCols_single')?.value) || 0;
            if (rows > 0 && cols > 0) {
                itemsToRender.push({ type: 'multiplicationArray', rows, cols, color: manipulative_unitCubeColor });
                totalItemCount = 1;
            }
        }
        else if (currentMode === 'tenFrame') {
            const frameSize = parseInt(document.getElementById('manipulative_tenFrameSize_single')?.value) || 10;
            const numDots = parseInt(document.getElementById('manipulative_tenFrameDots_single')?.value) || 0;
            let rows, cols;
            if (frameSize === 10) {
                rows = 2;
                cols = 5;
            } else {
                rows = frameSize / 10;
                cols = 10;
            }
            itemsToRender.push({ type: 'tenFrame', rows, cols, numDots });
            totalItemCount = 1;
        }
        else if (currentMode === 'hundredsChart') {
            const highlightType = document.getElementById('manipulative_hundredsChartHighlight_single')?.value || 'none';
            const highlightNumber = parseInt(document.getElementById('manipulative_hundredsChartNumberInput_single')?.value) || 0;
            itemsToRender.push({ type: 'hundredsChart', rows: 10, cols: 10, highlightType, highlightNumber });
            totalItemCount = 1;
        }

        let calculatedBaseSize = manipulative_baseSize;
        let iterationLimit = 50;
        while (iterationLimit-- > 0) {
            const canvasContentWidth = manipulative_mathCanvas.width - 2 * manipulative_padding;
            const availableDrawingHeight = manipulative_singleCanvasContainer.clientHeight - (2 * 16) - 2 * manipulative_padding;
            const simulatedLayout = manipulative_layoutAndRenderManipulatives(calculatedBaseSize, manipulative_mathCanvas.width, itemsToRender, null, false, manipulative_singleCanvasContainer);
            let needsShrink = simulatedLayout.totalContentWidth > canvasContentWidth + 1 || simulatedLayout.totalDrawingHeight > availableDrawingHeight + 1;
            let needsGrow = totalItemCount > 0 && simulatedLayout.totalContentWidth < canvasContentWidth * 0.8 && simulatedLayout.totalDrawingHeight < availableDrawingHeight * 0.8;

            if (needsShrink) {
                calculatedBaseSize *= 0.98;
                if (calculatedBaseSize < manipulative_minEffectiveBlockUnit) {
                    calculatedBaseSize = manipulative_minEffectiveBlockUnit;
                    break;
                }
            }
            else if (needsGrow) {
                calculatedBaseSize *= 1.02;
                if (calculatedBaseSize > manipulative_maxEffectiveBlockUnit) {
                    calculatedBaseSize = manipulative_maxEffectiveBlockUnit;
                    break;
                }
            }
            else {
                break;
            }
        }

        let finalBaseSize = Math.floor(calculatedBaseSize);
        finalBaseSize = Math.max(manipulative_minEffectiveBlockUnit, Math.min(manipulative_maxEffectiveBlockUnit, finalBaseSize));

        const finalLayout = manipulative_layoutAndRenderManipulatives(finalBaseSize, manipulative_mathCanvas.width, itemsToRender, null, false, manipulative_singleCanvasContainer);
        const finalRequiredCanvasHeight = Math.max(manipulative_singleCanvasContainer.clientHeight - (2 * 16), finalLayout.totalDrawingHeight);

        if (manipulative_mathCanvas.height !== finalRequiredCanvasHeight) {
            manipulative_mathCanvas.height = finalRequiredCanvasHeight;
            requestAnimationFrame(manipulative_handleDraw);
            return;
        }

        manipulative_layoutAndRenderManipulatives(finalBaseSize, manipulative_mathCanvas.width, itemsToRender, manipulative_ctx, true, manipulative_singleCanvasContainer);
    }

    function manipulative_getCalculationOrSummaryHTML() {
        let contentHtml = '';
        const currentMode = manipulative_currentMasterMode;

        if (currentMode === 'baseTenBlocks') {
            const total = (parseInt(document.getElementById('manipulative_block-1000_single')?.value) || 0) * 1000 + (parseInt(document.getElementById('manipulative_block-100_single')?.value) || 0) * 100 + (parseInt(document.getElementById('manipulative_block-10_single')?.value) || 0) * 10 + (parseInt(document.getElementById('manipulative_block-1_single')?.value) || 0);
            manipulative_totalValueTitle.textContent = 'Total Value:';
            contentHtml = `<p class="text-5xl font-bold">$${total}$</p>`;
        }
        else if (currentMode === 'algebraTiles') {
            manipulative_totalValueTitle.textContent = 'Algebraic Expression:';
            const x2 = (document.getElementById('manipulative_tile-x2_single')?.value || 0) - (document.getElementById('manipulative_tile-neg-x2_single')?.value || 0);
            const x = (document.getElementById('manipulative_tile-x_single')?.value || 0) - (document.getElementById('manipulative_tile-neg-x_single')?.value || 0);
            const one = (document.getElementById('manipulative_tile-1_single')?.value || 0) - (document.getElementById('manipulative_tile-neg-1_single')?.value || 0);

            let terms = [];
            if (x2 !== 0) terms.push((x2 === 1 ? '' : (x2 === -1 ? '-' : x2)) + 'x^2');
            if (x !== 0) terms.push((x > 0 ? (terms.length > 0 ? ' + ' : '') : ' - ') + (Math.abs(x) === 1 ? '' : Math.abs(x)) + 'x');
            if (one !== 0) terms.push((one > 0 ? (terms.length > 0 ? ' + ' : '') : ' - ') + Math.abs(one));

            contentHtml = `<p class="text-4xl font-bold">$${terms.join('') || '0'}$</p>`;
        }
        else if (currentMode === 'fractionStrips' || currentMode === 'fractionCircles') {
            manipulative_totalValueTitle.textContent = 'Total Value:';
            const type = currentMode === 'fractionStrips' ? 'fractionStrip' : 'fractionCircle';
            const container = document.getElementById('manipulative_' + type + 'InputsContainer_single');

            if (!container || container.children.length === 0) {
                contentHtml = '<p class="text-xl">Add a fraction to begin.</p>';
            } else {
                let totalN = 0;
                let totalD = 1;
                Array.from(container.children).forEach(row => {
                    const num = parseInt(row.querySelector('.fraction-numerator')?.value) || 0;
                    const den = parseInt(row.querySelector('.fraction-denominator')?.value) || 1;

                    if (den > 0) {
                        totalN = totalN * den + num * totalD;
                        totalD = totalD * den;
                    }
                });

                if (totalN === 0) {
                    contentHtml = '<p class="text-5xl font-bold">$0$</p>';
                } else {
                    const commonDivisor = gcd(totalN, totalD);
                    let simpN = totalN / commonDivisor;
                    let simpD = totalD / commonDivisor;

                    if (simpD < 0) { // Ensure denominator is positive
                        simpD = -simpD;
                        simpN = -simpN;
                    }

                    if (simpD === 1) {
                        contentHtml = `<p class="text-5xl font-bold">$${simpN}$</p>`;
                    } else if (Math.abs(simpN) >= simpD) {
                        const whole = Math.trunc(simpN / simpD);
                        const remN = Math.abs(simpN % simpD);
                        if (remN === 0) {
                            contentHtml = `<p class="text-5xl font-bold">$${whole}$</p>`;
                        } else {
                            contentHtml = `<p class="text-5xl font-bold">$${whole} \\frac{${remN}}{${simpD}}$</p>`;
                        }
                    } else {
                        contentHtml = `<p class="text-5xl font-bold">$\\frac{${simpN}}{${simpD}}$</p>`;
                    }
                }
            }
        }
        else if (currentMode === 'analogClock') {
            manipulative_totalValueTitle.textContent = 'Digital Time:';
            const hour = parseInt(document.getElementById('manipulative_clockHour_single')?.value) || 12;
            const minute = parseInt(document.getElementById('manipulative_clockMinute_single')?.value) || 0;
            contentHtml = `<p class="text-5xl font-mono font-bold">$${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}$</p>`;
        }
        else if (currentMode === 'probabilitySpinner') {
            manipulative_totalValueTitle.textContent = 'Spinner Result:';
            contentHtml = `<p class="text-5xl font-bold">$${manipulative_lastSpinnerResult.single !== null ? manipulative_lastSpinnerResult.single : '...'}$</p>`;
        }
        else if (currentMode === 'diceRoller') {
            manipulative_totalValueTitle.textContent = 'Dice Roll:';
            contentHtml = `<p class="text-5xl font-bold">$${manipulative_lastDiceResult.single !== null ? manipulative_lastDiceResult.single : '...'}$</p>`;
        }
        else if (currentMode === 'multiplicationArray') {
            const rows = parseInt(document.getElementById('manipulative_arrayRows_single')?.value) || 0, cols = parseInt(document.getElementById('manipulative_arrayCols_single')?.value) || 0;
            manipulative_totalValueTitle.textContent = 'Multiplication Array:';
            contentHtml = rows > 0 && cols > 0 ? `<p class="text-5xl font-bold">$${rows} \\times ${cols} = ${rows * cols}$</p>` : `<p class="text-xl">Enter rows and columns.</p>`;
        }
        else if (currentMode === 'tenFrame') {
            const frameSize = parseInt(document.getElementById('manipulative_tenFrameSize_single')?.value) || 0, numDots = parseInt(document.getElementById('manipulative_tenFrameDots_single')?.value) || 0;
            manipulative_totalValueTitle.textContent = 'Ten Frame:';
            contentHtml = `<p class="text-5xl font-bold">$${numDots} \\text{ in a } ${frameSize}\\text{-frame}$</p>`;
        }
        else if (currentMode === 'hundredsChart') {
            const highlightType = document.getElementById('manipulative_hundredsChartHighlight_single')?.value || 'none';
            const highlightNumber = parseInt(document.getElementById('manipulative_hundredsChartNumberInput_single')?.value) || 0;
            manipulative_totalValueTitle.textContent = 'Hundreds Chart:';
            let description = 'Displaying 1-100.';
            if (highlightType === 'prime') description = 'Highlighting Prime Numbers.';
            else if (highlightType === 'even') description = 'Highlighting Even Numbers.';
            else if (highlightType === 'odd') description = 'Highlighting Odd Numbers.';
            else if (highlightType === 'multiples') description = `Highlighting Multiples of ${highlightNumber}.`;
            else if (highlightType === 'factors') {
                const factors = manipulative_getFactors(highlightNumber);
                description = `Highlighting Factors of ${highlightNumber}: ${factors.join(', ')}.`;
            }
            contentHtml = `<p class="text-4xl font-semibold">$${description.replace(/:/g, ':\\\\ ')}$</p>`;
        }
        else if (currentMode === 'factorTree') {
            const num = parseInt(document.getElementById('manipulative_factorTreeNumberInput_single')?.value) || 0;
            manipulative_totalValueTitle.textContent = 'Prime Factorization:';
            if (isNaN(num) || num < 2) {
                contentHtml = `<p class="text-xl">Enter a number ≥ 2.</p>`;
            } else {
                const factors = manipulative_getPrimeFactorsList(num);
                let fString = factors.length === 1 && factors[0] === num ? `${num} \\text{ is prime.}` : `${num} = ${factors.join(' \\times ')}`;
                contentHtml = `<p class="text-4xl font-bold mt-4">$${fString}$</p>`;
            }
        }
        else if (currentMode === 'multiplicationNumberBond' || currentMode === 'additionNumberBond') {
            const isMult = currentMode === 'multiplicationNumberBond';
            const v1 = parseInt(document.getElementById(isMult ? 'manipulative_multFactor1Input_single' : 'manipulative_addAddend1Input_single')?.value) || 0;
            const v2 = parseInt(document.getElementById(isMult ? 'manipulative_multFactor2Input_single' : 'manipulative_addAddend2Input_single')?.value) || 0;
            const result = isMult ? v1 * v2 : v1 + v2;
            const op = isMult ? '\\times' : '+';
            manipulative_totalValueTitle.textContent = isMult ? 'Multiplication Number Bond:' : 'Addition Number Bond:';
            contentHtml = `<p class="text-4xl font-bold mt-4">$${v1} ${op} ${v2} = ${result}$</p>`;
        }

        return contentHtml;
    }

    function manipulative_handleDraw() {
        const currentMode = manipulative_currentMasterMode;

        if (currentMode === 'focusStatement') {
            // No canvas drawing needed
        } else {
            if (!manipulative_mathCanvas || !manipulative_ctx) return;
            manipulative_drawSingleManipulative();
            const contentHtml = manipulative_getCalculationOrSummaryHTML();
            if (manipulative_stepsContentContainer) manipulative_stepsContentContainer.innerHTML = contentHtml;

            if (window.MathJax && window.MathJax.startup) {
                MathJax.startup.promise.then(() => {
                    MathJax.typesetPromise([manipulative_stepsContentContainer, manipulative_dimensionInputsInline]).catch((err) => console.error("MathJax typesetting error:", err));
                });
            }
        }
    }

    function manipulative_setupInputsForSide(side) {
        let mode, container, suffix;

        mode = manipulative_currentMasterMode;
        container = manipulative_dimensionInputsInline;
        suffix = 'single';

        manipulative_isAnimating[side] = false;
        if (container) container.innerHTML = (inputTemplates[mode] || '').replaceAll('{SIDE}', suffix);

        const drawFunc = () => manipulative_handleDraw();

        if (container) {
            container.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', drawFunc);
                el.addEventListener('change', drawFunc);
            });
        }

        if (mode === 'fractionStrips') {
            const addStripBtn = document.getElementById(`manipulative_addFractionStrip_${suffix}`);
            if (addStripBtn) addStripBtn.onclick = () => manipulative_addFractionInputRow(`manipulative_fractionStripInputsContainer_${suffix}`, suffix);
            const stripContainer = document.getElementById(`manipulative_fractionStripInputsContainer_${suffix}`);
            if (stripContainer && !stripContainer.children.length) manipulative_addFractionInputRow(`manipulative_fractionStripInputsContainer_${suffix}`, suffix);
        }

        if (mode === 'fractionCircles') {
            const addCircleBtn = document.getElementById(`manipulative_addFractionCircle_${suffix}`);
            if (addCircleBtn) addCircleBtn.onclick = () => manipulative_addFractionInputRow(`manipulative_fractionCircleInputsContainer_${suffix}`, suffix, 1, 4);
            const circleContainer = document.getElementById(`manipulative_fractionCircleInputsContainer_${suffix}`);
            if (circleContainer && !circleContainer.children.length) manipulative_addFractionInputRow(`manipulative_fractionCircleInputsContainer_${suffix}`, suffix, 1, 4);
        }

        if (mode === 'factorTree') {
            const factorizeBtn = document.getElementById(`manipulative_factorizeButton_${suffix}`);
            if (factorizeBtn) factorizeBtn.onclick = drawFunc;
        }

        if (mode === 'hundredsChart') {
            const hs = document.getElementById(`manipulative_hundredsChartHighlight_${suffix}`);
            const ni = document.getElementById(`manipulative_hundredsChartNumberInput_${suffix}`);
            if (hs && ni) {
                hs.addEventListener('change', () => {
                    ni.classList.toggle('hidden', !['multiples', 'factors'].includes(hs.value));
                    drawFunc();
                });
            }
        }

        if (mode === 'tenFrame') {
            const di = document.getElementById(`manipulative_tenFrameDots_${suffix}`);
            if (di) {
                di.addEventListener('input', () => {
                    const fs = parseInt(document.getElementById(`manipulative_tenFrameSize_${suffix}`).value);
                    let v = parseInt(di.value);
                    di.value = isNaN(v) ? 0 : Math.max(0, Math.min(v, fs));
                    drawFunc();
                });
            }
        }

        if (mode === 'probabilitySpinner') {
            manipulative_lastSpinnerRotation[side] = 0;
            manipulative_lastSpinnerResult[side] = null;
            const spinBtn = document.getElementById(`manipulative_spinButton_${suffix}`);
            if (spinBtn) spinBtn.onclick = () => manipulative_startSpinnerAnimation(side);
        }

        if (mode === 'diceRoller') {
            manipulative_lastDiceResult[side] = null;
            const rollBtn = document.getElementById(`manipulative_rollButton_${suffix}`);
            if (rollBtn) rollBtn.onclick = () => manipulative_startDiceAnimation(side);
        }

        if (window.MathJax && window.MathJax.startup) {
            MathJax.startup.promise.then(() => {
                MathJax.typesetPromise([container]).catch(console.error);
            });
        }

        manipulative_resizeCanvases();
        manipulative_handleDraw();
    }

    function manipulative_addFractionInputRow(containerId, side, num = 1, den = 2) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const rowDiv = document.createElement('div');
        rowDiv.className = 'fraction-input-row';
        rowDiv.innerHTML = `<label class="text-sm font-semibold text-slate-700">Num:</label><input type="number" class="fraction-numerator w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="${num}" min="0"><label class="text-sm font-semibold text-slate-700">Den:</label><input type="number" class="fraction-denominator w-16 p-1 border-2 border-slate-300 rounded-lg text-center" value="${den}" min="1"><div class="flex items-center gap-1"><input type="checkbox" class="show-notation-checkbox" checked><label class="text-sm font-semibold text-slate-700">Notation</label></div><button type="button" class="remove-fraction-button">X</button>`;
        container.appendChild(rowDiv);

        const numInput = rowDiv.querySelector('.fraction-numerator');
        const denInput = rowDiv.querySelector('.fraction-denominator');
        const showNotationCheckbox = rowDiv.querySelector('.show-notation-checkbox');
        const removeButton = rowDiv.querySelector('.remove-fraction-button');
        const drawFunc = manipulative_handleDraw;

        numInput.addEventListener('input', drawFunc);
        denInput.addEventListener('input', drawFunc);
        showNotationCheckbox.addEventListener('change', drawFunc);

        numInput.addEventListener('blur', () => {
            const currentDenominator = parseInt(denInput.value) || 1;
            numInput.value = Math.min(currentDenominator, Math.max(0, parseInt(numInput.value) || 0));
            drawFunc();
        });

        denInput.addEventListener('blur', () => {
            const newDenominator = Math.max(1, parseInt(denInput.value) || 1);
            denInput.value = newDenominator;
            numInput.value = Math.min(newDenominator, Math.max(0, parseInt(numInput.value) || 0));
            drawFunc();
        });

        removeButton.addEventListener('click', () => {
            rowDiv.remove();
            if (container.children.length === 0) {
                manipulative_addFractionInputRow(containerId, side);
            }
            drawFunc();
        });
        drawFunc();
    }

    function manipulative_handleMasterModeChange() {
        manipulative_currentMasterMode = modeSelector.value;

        const isFocusStatement = manipulative_currentMasterMode === 'focusStatement';

        // Control Panels
        if (manipulative_singleModeControls) manipulative_singleModeControls.classList.toggle('hidden', isFocusStatement);
        if (manipulative_focusStatementModeControls) manipulative_focusStatementModeControls.classList.toggle('hidden', !isFocusStatement);

        // Display Panels
        if (manipulative_singleCanvasContainer) manipulative_singleCanvasContainer.classList.toggle('hidden', isFocusStatement);
        if (manipulative_focusStatementDisplayContainer) manipulative_focusStatementDisplayContainer.classList.toggle('hidden', !isFocusStatement);

        // UI Toggles
        if (manipulative_totalValueSection) manipulative_totalValueSection.classList.toggle('hidden', isFocusStatement || !answerToggleBtn.classList.contains('toggle-on'));
        if (answerToggleContainer) answerToggleContainer.classList.toggle('hidden', isFocusStatement);

        let controlsToToggle;
        if (isFocusStatement) {
            controlsToToggle = manipulative_focusStatementModeControls;
        } else {
            controlsToToggle = manipulative_singleModeControls;
        }

        if (controlsToToggle) controlsToToggle.classList.remove('hidden');
        if (menuControls) menuControls.classList.remove('hidden');
        if (menuToggleBtn) {
            menuToggleBtn.classList.add('toggle-on');
            menuToggleBtn.classList.remove('toggle-off');
        }
        if (menuToggleDot) menuToggleDot.classList.add('dot-on');

        if (isFocusStatement) {
            if (manipulative_focusStatementTextArea) manipulative_focusStatementTextArea.value = "Welcome to Focus Statement Mode.";
            if (manipulative_focusStatementLiveText) manipulative_focusStatementLiveText.innerHTML = manipulative_focusStatementTextArea.value;
            if (window.MathJax && window.MathJax.startup) {
                MathJax.startup.promise.then(() => {
                    MathJax.typesetPromise([manipulative_focusStatementLiveText]).catch((err) => console.error("MathJax typesetting error:", err));
                });
            }
        } else {
            manipulative_setupInputsForSide('single');
        }

        manipulative_handleDraw();
    }

    function manipulative_resizeCanvases() {
        if (manipulative_currentMasterMode !== 'focusStatement') {
            if (manipulative_mathCanvas && manipulative_singleCanvasContainer) {
                manipulative_mathCanvas.width = manipulative_singleCanvasContainer.clientWidth;
                manipulative_mathCanvas.height = manipulative_singleCanvasContainer.clientHeight;
            }
        }
        manipulative_handleDraw();
    }

    function manipulative_drawProbabilityTool(side) {
        const mode = manipulative_currentMasterMode;
        if (mode === 'probabilitySpinner') manipulative_drawSpinner(side);
        if (mode === 'diceRoller') manipulative_drawDice(side);
    }

    function manipulative_getCanvasForSide(side) {
        return manipulative_mathCanvas;
    }

    function manipulative_drawSpinner(side) {
        const canvasEl = manipulative_getCanvasForSide(side);
        const ctx_param = canvasEl.getContext('2d');
        const suffix = 'single';
        const rotation = manipulative_lastSpinnerRotation[side] || 0;
        const sections = parseInt(document.getElementById(`manipulative_spinnerSections_${suffix}`)?.value) || 6;
        const radius = Math.min(canvasEl.width, canvasEl.height) / 2 - manipulative_padding;
        const centerX = canvasEl.width / 2;
        const centerY = canvasEl.height / 2;
        const anglePerSection = (2 * Math.PI) / sections;

        ctx_param.clearRect(0, 0, canvasEl.width, canvasEl.height);
        ctx_param.save();
        ctx_param.translate(centerX, centerY);
        ctx_param.rotate(rotation);

        for (let i = 0; i < sections; i++) {
            ctx_param.beginPath();
            ctx_param.moveTo(0, 0);
            ctx_param.arc(0, 0, radius, i * anglePerSection, (i + 1) * anglePerSection);
            ctx_param.closePath();
            ctx_param.fillStyle = manipulative_spinnerColors[i % manipulative_spinnerColors.length];
            ctx_param.fill();
            ctx_param.stroke();

            ctx_param.save();
            ctx_param.rotate((i + 0.5) * anglePerSection);
            ctx_param.fillStyle = (manipulative_spinnerColors[i % manipulative_spinnerColors.length] === '#ffffff' || manipulative_spinnerColors[i % manipulative_spinnerColors.length] === '#f59e0b') ? 'black' : 'white';
            ctx_param.font = `bold ${radius * 0.15}px Montserrat`;
            ctx_param.textAlign = 'center';
            ctx_param.fillText(i + 1, radius * 0.7, 0);
            ctx_param.restore();
        }

        ctx_param.restore();

        ctx_param.fillStyle = manipulative_mainOutlineColor;
        ctx_param.beginPath();
        ctx_param.moveTo(centerX + radius + 5, centerY);
        ctx_param.lineTo(centerX + radius + 25, centerY - 10);
        ctx_param.lineTo(centerX + radius + 25, centerY + 10);
        ctx_param.closePath();
        ctx_param.fill();
    }

    function manipulative_drawDice(side) {
        const canvasEl = manipulative_getCanvasForSide(side);
        const ctx_param = canvasEl.getContext('2d');
        const suffix = 'single';
        const value = manipulative_lastDiceResult[side] || 1;
        const sides = parseInt(document.getElementById(`manipulative_diceSides_${suffix}`)?.value) || 6;
        const size = Math.min(canvasEl.width, canvasEl.height) * 0.4;
        const radius = size / 2;
        const centerX = canvasEl.width / 2;
        const centerY = canvasEl.height / 2;

        ctx_param.clearRect(0, 0, canvasEl.width, canvasEl.height);
        ctx_param.fillStyle = 'white';
        ctx_param.strokeStyle = manipulative_mainOutlineColor;
        ctx_param.lineWidth = 4;

        let shapeSides = 0;
        switch(sides) {
            case 4: shapeSides = 3; break;
            case 6: shapeSides = 4; break;
            case 8: shapeSides = 8; break;
            case 10: shapeSides = 10; break;
            case 12: shapeSides = 12; break;
            case 20: shapeSides = 20; break;
            default: shapeSides = 0;
        }

        if (shapeSides === 4 && sides === 6) {
            ctx_param.beginPath();
            ctx_param.roundRect(centerX - radius, centerY - radius, size, size, [size * 0.1]);
        } else if (shapeSides > 0) {
            manipulative_drawPolygon(ctx_param, centerX, centerY, radius, shapeSides);
        } else {
            ctx_param.beginPath();
            ctx_param.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        }

        ctx_param.fill();
        ctx_param.stroke();

        ctx_param.fillStyle = manipulative_mainOutlineColor;
        if (sides === 6) {
            const dotRadius = size * 0.08;
            const positions = {
                1: [[0.5, 0.5]],
                2: [[0.25, 0.25], [0.75, 0.75]],
                3: [[0.25, 0.25], [0.5, 0.5], [0.75, 0.75]],
                4: [[0.25, 0.25], [0.75, 0.25], [0.25, 0.75], [0.75, 0.75]],
                5: [[0.25, 0.25], [0.75, 0.25], [0.5, 0.5], [0.25, 0.75], [0.75, 0.75]],
                6: [[0.25, 0.25], [0.75, 0.25], [0.25, 0.5], [0.75, 0.5], [0.25, 0.75], [0.75, 0.75]],
            };
            const dotPositions = positions[value] || [];
            dotPositions.forEach(pos => {
                ctx_param.beginPath();
                ctx_param.arc(centerX - radius + pos[0] * size, centerY - radius + pos[1] * size, dotRadius, 0, 2 * Math.PI);
                ctx_param.fill();
            });
        } else {
            ctx_param.font = `bold ${size * 0.4}px Montserrat`;
            ctx_param.textAlign = 'center';
            ctx_param.textBaseline = 'middle';
            ctx_param.fillText(value, centerX, centerY);
        }
    }

    function manipulative_startSpinnerAnimation(side) {
        if (manipulative_isAnimating[side]) return;
        manipulative_isAnimating[side] = true;
        const suffix = 'single';
        const spinButton = document.getElementById(`manipulative_spinButton_${suffix}`);
        if (spinButton) spinButton.disabled = true;
        manipulative_lastSpinnerResult[side] = null;
        manipulative_handleDraw();

        const sections = parseInt(document.getElementById(`manipulative_spinnerSections_${suffix}`)?.value) || 6;
        const targetSection = Math.floor(Math.random() * sections);
        const anglePerSection = 2 * Math.PI / sections;
        const finalAngle = (2 * Math.PI) - (targetSection + 0.5) * anglePerSection;
        const totalRotation = finalAngle + (2 * Math.PI) * (Math.floor(Math.random() * 3) + 3);
        const duration = 3000;
        let startTime = null;

        function animationLoop(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = manipulative_easeOutCubic(progress);
            const currentRotation = easedProgress * totalRotation;

            manipulative_lastSpinnerRotation[side] = currentRotation;
            manipulative_drawProbabilityTool(side);

            if (progress < 1) {
                requestAnimationFrame(animationLoop);
            } else {
                manipulative_lastSpinnerRotation[side] = finalAngle;
                manipulative_isAnimating[side] = false;
                if (spinButton) spinButton.disabled = false;
                manipulative_lastSpinnerResult[side] = targetSection + 1;
                manipulative_handleDraw();
            }
        }

        requestAnimationFrame(animationLoop);
    }

    function manipulative_startDiceAnimation(side) {
        if (manipulative_isAnimating[side]) return;
        manipulative_isAnimating[side] = true;
        const suffix = 'single';
        const rollButton = document.getElementById(`manipulative_rollButton_${suffix}`);
        if (rollButton) rollButton.disabled = true;
        manipulative_lastDiceResult[side] = null;
        manipulative_handleDraw();

        const sides = parseInt(document.getElementById(`manipulative_diceSides_${suffix}`)?.value) || 6;
        const finalResult = Math.floor(Math.random() * sides) + 1;
        const duration = 1500;
        let startTime = null;

        function animationLoop(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;

            if (elapsed < duration) {
                manipulative_lastDiceResult[side] = Math.floor(Math.random() * sides) + 1;
                manipulative_drawProbabilityTool(side);
                requestAnimationFrame(animationLoop);
            } else {
                manipulative_isAnimating[side] = false;
                if (rollButton) rollButton.disabled = false;
                manipulative_lastDiceResult[side] = finalResult;
                manipulative_handleDraw();
            }
        }

        requestAnimationFrame(animationLoop);
    }

    function manipulative_handleMenuToggle() {
        const currentMode = manipulative_currentMasterMode;
        const isFocusStatement = currentMode === 'focusStatement';
        let controlsToToggle;

        if (isFocusStatement) {
            controlsToToggle = manipulative_focusStatementModeControls;
        } else {
            controlsToToggle = manipulative_singleModeControls;
        }

        const isHidden = controlsToToggle.classList.toggle('hidden');
        if (menuControls) menuControls.classList.toggle('hidden', isHidden);
        if (menuToggleBtn) {
            menuToggleBtn.classList.toggle('toggle-on', !isHidden);
            menuToggleBtn.classList.toggle('toggle-off', isHidden);
        }
        if (menuToggleDot) menuToggleDot.classList.toggle('dot-on', !isHidden);
    }

    function manipulative_handleAnswerToggle() {
        if (manipulative_totalValueSection) {
            const isHidden = manipulative_totalValueSection.classList.toggle('hidden');
            if (answerToggleBtn) {
                answerToggleBtn.classList.toggle('toggle-on', !isHidden);
                answerToggleBtn.classList.toggle('toggle-off', isHidden);
            }
            if (answerToggleDot) answerToggleDot.classList.toggle('dot-on', !isHidden);
        }
        if (manipulative_currentMasterMode !== 'focusStatement') {
            manipulative_handleDraw();
        }
    }

    function manipulative_initialize() {
        if (manipulative_focusStatementTextArea) {
            manipulative_focusStatementTextArea.addEventListener('input', (e) => {
                if (manipulative_focusStatementLiveText) manipulative_focusStatementLiveText.innerHTML = e.target.value;
                if (window.MathJax && window.MathJax.startup) {
                    MathJax.startup.promise.then(() => {
                        MathJax.typesetPromise([manipulative_focusStatementLiveText]).catch((err) => console.error("MathJax typesetting error:", err));
                    });
                }
            });
        }
        window.addEventListener('resize', manipulative_resizeCanvases);
    }

    // --- INITIALIZATION ---
    initializeDOM();
    handleModeChange();

    </script>
</body>
</html>